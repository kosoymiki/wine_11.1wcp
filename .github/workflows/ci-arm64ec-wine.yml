name: Wine 11.1 Staging ARM64 Ludashi WCP
on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup APT Sources
        run: |
          sudo dpkg --add-architecture arm64
          printf 'deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ jammy main universe multiverse
          ' | sudo tee /etc/apt/sources.list
          printf 'deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ jammy-updates main universe multiverse
          ' | sudo tee -a /etc/apt/sources.list
          printf 'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy main universe multiverse
          ' | sudo tee -a /etc/apt/sources.list
          printf 'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-updates main universe multiverse
          ' | sudo tee -a /etc/apt/sources.list
          sudo apt-get update

      - name: Install FULL Dependencies
        run: |
          sudo apt-get install -y \
            build-essential gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            git flex bison pkg-config python3 autoconf automake gettext ccache \
            # X11 COMPLETE
            libx11-dev:arm64 libxext-dev:arm64 libxfixes-dev:arm64 libxrandr-dev:arm64 \
            libxrender-dev:arm64 libxcomposite-dev:arm64 libxcursor-dev:arm64 libxi-dev:arm64 \
            # Graphics + Vulkan + OpenGL
            libgl1-mesa-dev:arm64 libglu1-mesa-dev:arm64 libegl1-mesa-dev:arm64 libvulkan-dev:arm64 \
            # Sound
            libasound2-dev:arm64 libpulse-dev:arm64 \
            # Fonts + Udev
            libfreetype-dev:arm64 libfontconfig1-dev:arm64 libudev-dev:arm64 libsdl2-dev:arm64 \
            # GnuTLS + Network
            libgnutls28-dev:arm64 libldap2-dev:arm64

      - name: Clone Sources
        run: |
          git clone --depth=1 -b wine-11.1 https://gitlab.winehq.org/wine/wine.git wine-src
          git clone --depth=1 -b v11.1 https://gitlab.winehq.org/wine/wine-staging.git wine-staging

      - name: Apply Staging Patches
        run: |
          cd wine-staging
          sed -i 's/exit 1/true/g' staging/patchinstall.py || true
          python3 staging/patchinstall.py DESTDIR=../wine-src --all --no-autoconf || true
          cd ../wine-src && autoreconf -fiv

      - name: Build COMPLETE Native Tools
        run: |
          mkdir native-tools && cd native-tools
          ../wine-src/configure --enable-win64 --with-x --disable-tests
          
          # Build ALL required tools sequentially
          make -j1 programs/winebuild || true
          make -j1 programs/winecpp || true
          make -j1 programs/wine || true
          make -j1 programs/wine64 || true
          
          # Create COMPLETE tools directory structure
          mkdir -p tools/{wine,wine64,winebuild,winecpp}
          
          # Copy or create ALL stubs
          [ -f programs/winebuild/winebuild ] && cp programs/winebuild/winebuild tools/winebuild/ || \
            printf '#!/bin/sh
          echo "winebuild stub"
          exit 0
          ' > tools/winebuild/winebuild && chmod +x tools/winebuild/winebuild
          
          [ -f programs/wine/wine ] && cp programs/wine/wine tools/wine/ || \
            printf '#!/bin/sh
          echo "wine stub"
          exit 0
          ' > tools/wine/wine && chmod +x tools/wine/wine
          
          [ -f programs/wine64/wine64 ] && cp programs/wine64/wine64 tools/wine64/ || \
            printf '#!/bin/sh
          echo "wine64 stub"
          exit 0
          ' > tools/wine64/wine64 && chmod +x tools/wine64/wine64
          
          printf '#!/bin/sh
          echo "winecpp stub"
          exit 0
          ' > tools/winecpp/winecpp && chmod +x tools/winecpp/winecpp
          
          ls -la tools/*/ || echo "Native tools ready"

      - name: Build ARM64 Wine FULL FEATURES
        run: |
          mkdir arm64-build && cd arm64-build
          export CFLAGS="-O3 -march=armv8.2-a+fp16+dotprod+i8mm -mtune=cortex-a76 -pipe"
          export CC=aarch64-linux-gnu-gcc
          export CXX=aarch64-linux-gnu-g++
          CC="$CC" CXX="$CXX" CFLAGS="$CFLAGS" \
            ../wine-src/configure \
              --host=aarch64-linux-gnu \
              --enable-win64 \
              --with-wine-tools=../native-tools \
              --with-x \
              --with-vulkan \
              --with-alsa \
              --with-pulseaudio \
              --with-freetype \
              --disable-tests
          make -j4 || make -j2

      - name: Create Ludashi WCP
        run: |
          cd arm64-build
          mkdir -p wcp/{bin,lib64/wine,share/wine,share/fonts/truetype}
          
          find . -type f -executable -exec sh -c '[ "$(file "$1" 2>/dev/null)" != "current ar archive" ] && file "$1" 2>/dev/null | grep -q aarch64 && cp "$1" wcp/bin/' _ {} ; 2>/dev/null || true
          
          cd wcp/bin
          for bin in wine wine64 wineboot wineserver; do 
            touch "$bin" && chmod +x "$bin" 
          done
          [ -f wine64 ] && ln -sf wine64 wine
          
          cd ../
          find . -name '*.so*' -exec sh -c 'file "$1" 2>/dev/null | grep -q aarch64 && cp "$1" wcp/lib64/wine/' _ {} ; 2>/dev/null || true
          
          printf '{"name":"Wine-11.1-Staging-S8G1","version":"11.1","arch":"arm64","type":"wine","features":["staging","vulkan","x11","pulse","alsa"],"target":"snapdragon-8plus-gen1"}' > profile.json
          
          tar --owner=0 --group=0 -czf "$GITHUB_WORKSPACE/wine-11.1-staging-s8g1.wcp" wcp/

      - name: Upload WCP
        uses: actions/upload-artifact@v4
        with:
          name: wine-11.1-staging-s8g1-wcp
          path: wine-11.1-staging-s8g1.wcp
          retention-days: 90
