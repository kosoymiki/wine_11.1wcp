name: Build Wine 11 ARM64EC for Winlator Ludashi

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_wine_arm64ec:
    runs-on: ubuntu-24.04

    env:
      LLVM_MINGW_URL: https://github.com/mstorsjo/llvm-mingw/releases/download/20231128/llvm-mingw-20231128-ucrt-ubuntu-20.04-x86_64.tar.xz

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup ARM64-Compatible Repositories and Dependencies
        run: |
          set -euo pipefail
          echo "=== Настройка arm64 и репозиториев ==="

          # Основная архитектура
          ARCH=$(dpkg --print-architecture)
          echo "Основная архитектура: $ARCH"

          # Проверяем доступность портов Ubuntu для arm64
          PORTS_URL="http://ports.ubuntu.com/ubuntu-ports"
          DISTRO="noble"
          COMPONENTS=("main" "universe" "multiverse" "restricted")
          
          echo "Смена стандартных репозиториев на порты Ubuntu"
          sudo sed -i "s|http://archive.ubuntu.com/ubuntu/|$PORTS_URL/|g" /etc/apt/sources.list
          sudo sed -i "s|http://security.ubuntu.com/ubuntu|$PORTS_URL|g" /etc/apt/sources.list

          # Безопасно добавляем архитектуру arm64 только если пакеты есть
          sudo dpkg --remove-architecture arm64 || true
          for comp in "${COMPONENTS[@]}"; do
            if curl -sfI "$PORTS_URL/dists/$DISTRO/$comp/binary-arm64/Packages" > /dev/null; then
              echo "✔ arm64 доступен для $comp"
              sudo dpkg --add-architecture arm64
              break
            else
              echo "✖ arm64 недоступен для $comp"
            fi
          done

          sudo apt-get update -y

          echo "Установка зависимостей"
          sudo apt-get install -y \
            curl wget unzip pkgconf git cmake make \
            flex bison gettext \
            zlib1g-dev libfreetype6-dev libfontconfig1-dev \
            libx11-dev libxext-dev libxrender-dev libxml2-dev libssl-dev \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libc6-dev-arm64-cross libstdc++-arm64-cross

      - name: Setup LLVM MinGW for ARM64EC
        run: |
          wget $LLVM_MINGW_URL -O llvm-mingw.tar.xz
          tar xf llvm-mingw.tar.xz
          mv llvm-mingw-20231128-ucrt-ubuntu-20.04-x86_64 llvm-mingw
          echo "$PWD/llvm-mingw/bin" >> $GITHUB_PATH

      - name: Clone Wine 11 Source
        run: git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine-src

      - name: Build Wine Tools (Host x86_64)
        run: |
          mkdir wine-tools-build
          cd wine-tools-build
          ../wine-src/configure --disable-tests --without-x --prefix=$PWD/install
          make -j$(nproc) tools
          echo "WINE_TOOLS=$PWD/install/bin" >> $GITHUB_ENV

      - name: Configure Wine Cross-Compile ARM64EC
        run: |
          mkdir wine-build
          cd wine-build

          export CC="clang --target=aarch64-w64-mingw32 --sysroot=$PWD/../llvm-mingw"
          export CXX="clang++ --target=aarch64-w64-mingw32 --sysroot=$PWD/../llvm-mingw"
          export AR=aarch64-w64-mingw32-ar
          export LD=aarch64-w64-mingw32-llvm-ld
          export RANLIB=aarch64-w64-mingw32-ranlib
          export CFLAGS="-O3 -march=armv8.2-a+fp16+dotprod -fno-plt"
          export CXXFLAGS="$CFLAGS"
          export LDFLAGS="-fuse-ld=lld"

          ../wine-src/configure \
            --host=aarch64-w64-mingw32 \
            --with-wine64 \
            --without-wine \
            --with-wine-tools=$WINE_TOOLS \
            --with-mingw=clang \
            --prefix=/opt/wine-arm64ec \
            --disable-tests \
            --enable-archs=arm64ec \
            --without-x \
            --with-vulkan

      - name: Build Wine ARM64EC
        working-directory: wine-build
        run: make -j$(nproc)

      - name: Install Wine ARM64EC
        working-directory: wine-build
        run: make DESTDIR=$PWD/../image install

      - name: Package Wine as .wcp for Winlator
        run: |
          mkdir -p image/opt
          mv image/opt/wine-arm64ec Wine-11.1-ARM64EC

          cat <<EOF > Wine-11.1-ARM64EC/info.json
          {
            "name": "Wine-11.1-ARM64EC",
            "version": "11.1-git",
            "arch": "arm64ec",
            "runtime": "winlator-ludashi",
            "description": "Native ARM64EC build for Winlator (No Box64/Box86 needed)"
          }
          EOF

          cat <<'EOF' > Wine-11.1-ARM64EC/env.sh
          #!/bin/sh
          export WINEDEBUG="-all"
          export WINE_ENABLE_ARM64EC=1
          EOF
          chmod +x Wine-11.1-ARM64EC/env.sh

          tar -cJf ../../wine-arm64ec.wcp Wine-11.1-ARM64EC

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-arm64ec.wcp
          path: wine-arm64ec.wcp
