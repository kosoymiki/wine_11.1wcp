name: Build Wine ARM64EC (cross LLVM‑Mingw)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      MAKEFLAGS: -j$(nproc)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup multiarch and apt sources
        run: |
          set -eux
          sudo dpkg --add-architecture arm64
          sudo dpkg --add-architecture i386
          sudo apt-get update

      - name: Install build dependencies
        run: |
          set -eux
          sudo apt-get install -y --no-install-recommends \
            build-essential autoconf automake libtool pkgconf \
            git python3 gettext bash-completion cmake ninja-build

          sudo apt-get install -y --no-install-recommends \
            libc6-dev:aarch64 libc6-dev:arm64 libc6-dev:i386 \
            linux-libc-dev:arm64 \
            libfreetype6-dev libfontconfig1-dev \
            libsdl2-dev libpulse-dev libasound2-dev \
            libdbus-1-dev libdb-dev \
            libavcodec-dev libavformat-dev libavutil-dev libswscale-dev \
            libx11-dev libxrandr-dev libxrender-dev \
            libxi-dev libxinerama-dev libxfixes-dev \
            libxcomposite-dev libxdamage-dev

      - name: Download latest llvm‑mingw toolchain
        run: |
          set -eux
          # Latest release from mstorsjo/llvm-mingw
          LLVM_VER="20251118"
          LLVM_FILE="llvm-mingw-${LLVM_VER}-ucrt-ubuntu-22.04-x86_64.tar.xz"
          LLVM_URL="https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_VER}/${LLVM_FILE}"

          curl -L --retry 5 -o "$LLVM_FILE" "$LLVM_URL"
          mkdir -p llvm-mingw
          tar -xJf "$LLVM_FILE" -C llvm-mingw --strip-components=1
          echo "$PWD/llvm-mingw/bin" >> "$GITHUB_PATH"

      - name: Build host Wine tools (native)
        run: |
          set -eux
          mkdir -p host
          cd host
          ../wine/configure \
            --disable-tests \
            --without-x \
            --without-wayland
          make -j$(nproc)

      - name: Configure and build Wine
        run: |
          set -eux
          mkdir -p build
          cd build

          export PKG_CONFIG=pkgconf
          export CC="clang"
          export CXX="clang++"
          export AR="llvm-ar"
          export LD="lld"
          export NM="llvm-nm"
          export RANLIB="llvm-ranlib"
          export CPPFLAGS="-I/usr/include/freetype2 ${CPPFLAGS:-}"

          ../wine/configure \
            --build=$(../wine/config.guess) \
            --host=aarch64-w64-mingw32 \
            --with-wine-tools=../host \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64,i386 \
            --disable-tests \
            --with-freetype \
            --with-fontconfig \
            --with-sdl2 \
            --with-alsa \
            --with-pulse \
            --with-db \
            --with-inotify \
            --without-pcap \
            --with-ffmpeg \
            --with-x

          make -j$(nproc)
          DESTDIR=$PWD/install make install

      - name: Package PHAT layout
        run: |
          set -eux
          rm -rf wcp
          mkdir -p wcp/bin wcp/lib/wine/aarch64-unix wcp/lib/wine/aarch64-windows wcp/lib/wine/arm64ec-windows wcp/share/wine

          PREFIX="build/install/usr/local"
          cp -a "$PREFIX/bin/"* wcp/bin/
          cp -a "$PREFIX/share/wine/"* wcp/share/wine/ || true
          cp -a "$PREFIX/lib/wine/"* wcp/lib/wine/

          cat > wcp/env.sh <<EOF
          #!/usr/bin/env sh
          HERE="\$(cd "\$(dirname "\$0")" && pwd)"
          export PATH="\$HERE/bin:\$PATH"
          EOF
          chmod +x wcp/env.sh

          cat > wcp/info.json <<EOF
          {
            "name": "wine-11.1-arm64ec-phat",
            "archs": ["aarch64-unix","aarch64-windows","arm64ec-windows","i386-windows"]
          }
          EOF

          tar -cJf wine-11.1-arm64ec-phat.tar.xz wcp
          ls -lh wine-11.1-arm64ec-phat.tar.xz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-arm64ec-phat
          path: wine-11.1-arm64ec-phat.tar.xz
