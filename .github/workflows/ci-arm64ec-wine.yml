name: Build ARM64EC Wine and Package .wcp file

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build_arm64ec_wine:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup QEMU user emulation
        uses: docker/setup-qemu-action@v2
        with:
          platforms: aarch64

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang llvm lld pkgconf git autoconf automake \
            libtool flex bison gettext \
            libsdl2-dev libvulkan-dev libx11-dev libxext-dev libxrandr-dev \
            libxrender-dev libxcursor-dev libxi-dev libfreetype6-dev \
            libfontconfig-dev libdbus-1-dev libudev-dev libasound2-dev \
            libcapi20-dev libusb-1.0-0-dev libgnutls28-dev libpulse-dev \
            libsqlite3-dev libosmesa6-dev libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev libunwind-dev unzip

      - name: Install LLVM-MinGW toolchain
        run: |
          wget https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-x86_64.zip
          unzip llvm-mingw-20251216-ucrt-x86_64.zip
          TOOLCHAIN_DIR=$(find . -maxdepth 1 -type d -name "llvm-mingw-*-ucrt-x86_64*" | head -n1)
          sudo mv "$TOOLCHAIN_DIR" /opt/llvm-mingw
          echo "/opt/llvm-mingw/bin" >> $GITHUB_PATH

      - name: Clone Wine source
        run: |
          git clone --depth 1 --branch "wine-11.1" https://gitlab.winehq.org/wine/wine.git wine-src

      - name: Configure Wine build
        working-directory: wine-src
        run: |
          # Указываем clang с явным таргетом и sysroot на LLVM-MinGW
          export CC="clang --target=aarch64-w64-mingw32 --sysroot=/opt/llvm-mingw/aarch64-w64-mingw32"
          export CXX="clang++ --target=aarch64-w64-mingw32 --sysroot=/opt/llvm-mingw/aarch64-w64-mingw32"
          export AR=llvm-ar
          export LD=lld
          export RANLIB=llvm-ranlib
          export STRIP=llvm-strip

          export CFLAGS="-march=armv8.2-a+fp16+dotprod -O3 -fno-plt"
          export CXXFLAGS="$CFLAGS"
          export LDFLAGS="-fuse-ld=lld"

          # Добавляем Mingw-инклуды и либы в путь компилятора
          export CFLAGS="$CFLAGS -I/opt/llvm-mingw/aarch64-w64-mingw32/include"
          export LDFLAGS="$LDFLAGS -L/opt/llvm-mingw/aarch64-w64-mingw32/lib"

          ./configure \
            --enable-archs=arm64ec,aarch64 \
            --host=arm64ec-w64-mingw32 \
            --with-mingw=clang \
            --without-x \
            --disable-tests \
            --prefix=/usr

      - name: Build Wine
        working-directory: wine-src
        run: |
          make -j$(nproc)

      - name: Install Wine into artifact directory
        working-directory: wine-src
        run: |
          make DESTDIR=$PWD/artifact install

      - name: Create .wcp structure
        run: |
          mkdir -p wine-arm64ec-wcp/arch/arm64ec/bin
          mkdir -p wine-arm64ec-wcp/arch/arm64ec/lib
          mkdir -p wine-arm64ec-wcp/arch/arm64ec/etc

          cp -a wine-src/artifact/usr/bin/* wine-arm64ec-wcp/arch/arm64ec/bin/
          cp -a wine-src/artifact/usr/lib/* wine-arm64ec-wcp/arch/arm64ec/lib/

          cat << 'EOF' > wine-arm64ec-wcp/manifest.json
          {
          "name": "Wine11-ARM64EC",
          "version": "wine-11.1",
          "arch": "arm64ec",
          "runtime": "winlator-ludashi"
          }
          EOF

          echo "wine-11.1" > wine-arm64ec-wcp/version.txt

          cat << 'EOF' > wine-arm64ec-wcp/arch/arm64ec/etc/env.sh
          #!/bin/sh
          export WINEDEBUG="-all"
          export WINE_ENABLE_ARM64EC=1
          EOF

          chmod +x wine-arm64ec-wcp/arch/arm64ec/etc/env.sh

      - name: Upload .wcp artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-arm64ec-wcp
          path: wine-arm64ec-wcp
