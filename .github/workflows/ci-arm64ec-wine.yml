name: Build Wine11.1 ARM64EC WCP for Winlator

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm

    defaults:
      run:
        shell: bash

    steps:

    ###################################################
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    ###################################################
    - name: Install build dependencies
      run: |
        set -euxo pipefail
        sudo apt update

        sudo apt install -y --no-install-recommends \
          build-essential autoconf automake libtool pkg-config \
          git gettext flex bison cmake ninja-build python3 python3-pip \
          libsdl2-dev libvulkan-dev libfreetype-dev libfontconfig-dev \
          libx11-dev libxext-dev libxfixes-dev libxinerama-dev libxi-dev \
          libxrandr-dev libxrender-dev libxxf86vm-dev libxcursor-dev \
          libxss-dev libasound2-dev libpulse-dev libv4l-dev \
          libusb-1.0-0-dev libudev-dev libxml2-dev libjpeg-dev libpng-dev \
          libldap2-dev inotify-tools
        sudo apt clean
        sudo rm -rf /var/lib/apt/lists/*

    ###################################################
    - name: Setup llvm-mingw (20260127)
      run: |
        set -euxo pipefail

        # Use exactly the release you specified
        RELEASE_URL="https://github.com/mstorsjo/llvm-mingw/releases/download/20260127/llvm-mingw-20260127-ucrt-ubuntu-22.04-aarch64.tar.xz"
        wget -q "$RELEASE_URL"
        mkdir -p llvm-mingw
        tar -xJf llvm-mingw-20260127-ucrt-ubuntu-22.04-aarch64.tar.xz -C llvm-mingw --strip-components=1

        # Add to PATH for clang/ld/lld
        echo "$PWD/llvm-mingw/bin" >> "$GITHUB_PATH"

    ###################################################
    - name: Clone Wine + wine‑staging + wine‑tkg
      run: |
        set -euxo pipefail
        git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 --branch v11.1 https://github.com/wine-staging/wine-staging.git wine-staging
        git clone https://github.com/Frogging-Family/wine-tkg-git.git wine-tkg

    ###################################################
    - name: Apply Wine‑staging patches
      run: |
        set -euxo pipefail
        cd wine
        python3 ../wine-staging/staging/patchinstall.py --all --destdir="$(pwd)"
        cd ..

    ###################################################
    - name: Create tkg customization.cfg
      run: |
        set -euxo pipefail
        mkdir -p wine/tkg-custom
        cat > wine/tkg-custom/customization.cfg << 'EOF'
        _use_staging="true"
        _use_esync="true"
        _use_fsync="true"
        _use_mono="false"
        _use_gecko="false"
        _use_fullscreen_hack="true"
        _optimize_cflags="-O2"
        _optimize_cxxflags="-O2"
        _EXTERNAL_INSTALL="false"
        EOF

    ###################################################
    - name: Configure & Build Wine (with wine‑tools)
      run: |
        set -euxo pipefail

        cd wine

        # Build wine-tools
        mkdir wine-tools-build
        cd wine-tools-build
        ../configure \
          --enable-tools \
          --disable-tests \
          --disable-win16 \
          --enable-archs=aarch64
        make -j"$(nproc)"
        cd ..

        # Prepare patches
        bash ../wine-tkg/wine-tkg-git/wine-tkg-scripts/prepare.sh

        mkdir build
        cd build

        export PKG_CONFIG_PATH="$PWD/../../../llvm-mingw/aarch64-w64-mingw32/lib/pkgconfig:$PKG_CONFIG_PATH"

        export BUILD=aarch64-linux-gnu
        export HOST=aarch64-w64-mingw32
        export CC=aarch64-w64-mingw32-clang
        export CXX=aarch64-w64-mingw32-clang++
        export AR=aarch64-w64-mingw32-ar
        export LD=aarch64-w64-mingw32-lld
        export RC=aarch64-w64-mingw32-windres
        export RANLIB=aarch64-w64-mingw32-ranlib

        ../configure \
          --build="$BUILD" \
          --host="$HOST" \
          --with-mingw=clang \
          --with-wine-tools="../wine-tools-build" \
          --prefix=/usr \
          --enable-win64 \
          --enable-wow64 \
          --enable-archs=arm64ec,aarch64 \
          --disable-tests \
          --without-mono \
          --without-gecko \
          --with-freetype \
          --with-fontconfig \
          --with-alsa \
          --with-pulse \
          --with-vulkan \
          --with-system-sdl2
        make -j"$(nproc)"

    ###################################################
    - name: Build DXVK
      run: |
        set -euxo pipefail
        git clone https://github.com/doitsujin/dxvk.git dxvk
        cd dxvk
        git submodule update --init --recursive
        pip3 install meson ninja
        meson setup build \
          --cross-file=../wine/build/config/meson.cross.arm64ec.ini \
          --prefix=/usr \
          -Dbuild_tests=false
        ninja -C build && ninja -C build install

    ###################################################
    - name: Build VKD3D‑Proton
      run: |
        set -euxo pipefail
        git clone https://github.com/HansKristian-Work/vkd3d-proton.git vkd3d
        cd vkd3d
        git submodule update --init --recursive
        meson setup build \
          --cross-file=../wine/build/config/meson.cross.arm64ec.ini \
          --prefix=/usr \
          -Dbuild_tests=false
        ninja -C build && ninja -C build install

    ###################################################
    - name: Build TURNIP Mesa Vulkan
      run: |
        set -euxo pipefail
        git clone https://gitlab.freedesktop.org/mesa/mesa.git mesa
        cd mesa
        pip3 install meson ninja
        meson setup builddir \
          -Dvulkan-drivers=turnip \
          -Dgallium-drivers=freedreno \
          -Dplatforms=android,x11 \
          --cross-file=../wine/build/config/meson.cross.arm64ec.ini \
          -Dbuildtype=release
        ninja -C builddir && ninja -C builddir install

    ###################################################
    - name: Package .wcp for Winlator
      run: |
        set -euxo pipefail
        cd wine/build
        DESTDIR=$PWD/install make install
        cd install

        mkdir -p wcp/{bin,lib/wine,share}
        cp -a usr/bin/* wcp/bin/ 2>/dev/null || true
        cp -a usr/lib/wine/* wcp/lib/wine/ 2>/dev/null || true
        cp -a usr/share/* wcp/share/ 2>/dev/null || true

        cd wcp/bin && ln -sf wine64 wine && cd ../..
        find bin -type f -exec chmod +x {} + || true
        find lib -name "*.so*" -exec chmod +x {} + || true

        cat > profile.json << 'EOF'
        {
          "id": "wine11.1-arm64ec-staging",
          "name": "Wine 11.1 Staging ARM64EC",
          "version": "11.1",
          "arch": "arm64ec",
          "files": {
            "bin": "bin/",
            "lib": "lib/",
            "share": "share/"
          }
        }
        EOF

        tar -cJf "$GITHUB_WORKSPACE/wine11.1-arm64ec-staging.wcp" profile.json wcp

    ###################################################
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine11.1-arm64ec-staging
        path: wine11.1-arm64ec-staging.wcp
