name: Build Wine 11.1 Staging‑TkG ARM64EC + Winlator .wcp

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm

    defaults:
      run:
        shell: bash

    steps:

    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install build dependencies
      run: |
        set -euxo pipefail
        sudo apt update
        sudo apt install -y --no-install-recommends \
          build-essential autoconf automake libtool pkg-config \
          python3 python3-pip git gettext flex bison \
          ninja-build cmake meson \
          libasound2-dev libpulse-dev libv4l-dev \
          libx11-dev libxext-dev libxfixes-dev libxinerama-dev \
          libxi-dev libxrandr-dev libxrender-dev \
          libfontconfig-dev \
          libgnutls28-dev libdbus-1-dev libsdl2-dev \
          libjpeg-dev libpng-dev libxml2-dev \
          libudev-dev libusb-1.0-0-dev libldap2-dev \
          libxkbcommon-dev libxv-dev libxxf86vm-dev \
          libxcursor-dev libxss-dev \
          libvulkan-dev lld llvm clang \
          python3-setuptools python3-wheel
        sudo apt clean

    - name: Setup llvm-mingw toolchain
      run: |
        set -euxo pipefail
        TOOLCHAIN_VER="20260127"
        FILE="llvm-mingw-${TOOLCHAIN_VER}-ucrt-ubuntu-22.04-aarch64.tar.xz"
        wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/${TOOLCHAIN_VER}/${FILE}"
        mkdir llvm-mingw
        tar -xJf "$FILE" -C llvm-mingw --strip-components=1
        echo "$PWD/llvm-mingw/bin" >> "$GITHUB_PATH"

    - name: Verify cross‑compiler
      run: |
        set -euxo pipefail
        aarch64-w64-mingw32-clang --version
        echo 'int main(void){return 0;}' > /tmp/test.c
        aarch64-w64-mingw32-clang /tmp/test.c -o /tmp/test.exe

    - name: Cross‑compile core deps
      run: |
        set -euxo pipefail
        PREFIX_DEPS="$PWD/deps/install"
        mkdir -p "$PREFIX_DEPS"/{lib/pkgconfig,include,bin}
        mkdir -p deps/build
        cd deps/build

        export TOOLCHAIN=aarch64-w64-mingw32
        export CC=${TOOLCHAIN}-clang
        export CXX=${TOOLCHAIN}-clang++
        export AR=${TOOLCHAIN}-ar
        export RANLIB=${TOOLCHAIN}-ranlib
        export WINDRES=${TOOLCHAIN}-windres

        export PKG_CONFIG_PATH="$PREFIX_DEPS/lib/pkgconfig:$PKG_CONFIG_PATH"
        export PKG_CONFIG_SYSROOT_DIR="$PREFIX_DEPS"
        export CFLAGS="-I$PREFIX_DEPS/include $CFLAGS"
        export LDFLAGS="-L$PREFIX_DEPS/lib $LDFLAGS"

        git clone --depth=1 https://github.com/madler/zlib.git zlib
        cd zlib
        ./configure --prefix="$PREFIX_DEPS" --static
        make -j"$(nproc)" && make install
        cd ..

        git clone --depth=1 https://github.com/glennrp/libpng.git libpng
        cd libpng
        ./configure --host="$TOOLCHAIN" \
          --prefix="$PREFIX_DEPS" --disable-shared --enable-static \
          CPPFLAGS="-I$PREFIX_DEPS/include" LDFLAGS="-L$PREFIX_DEPS/lib"
        make -j"$(nproc)" && make install
        cd ..

        git clone --depth=1 https://github.com/libjpeg-turbo/libjpeg-turbo.git libjpeg
        cd libjpeg
        cmake -S . -B build \
          -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_SYSTEM_PROCESSOR=ARM64 \
          -DCMAKE_C_COMPILER="$CC" \
          -DCMAKE_CXX_COMPILER="$CXX" \
          -DCMAKE_INSTALL_PREFIX="$PREFIX_DEPS" \
          -DENABLE_SHARED=OFF -DENABLE_STATIC=ON
        cmake --build build --parallel "$(nproc)"
        cmake --install build
        cd ..

        git clone --depth=1 https://git.savannah.gnu.org/git/freetype/freetype2.git freetype2
        cd freetype2
        mkdir -p build && cd build
        ../configure --host="$TOOLCHAIN" --prefix="$PREFIX_DEPS" \
          --disable-shared --enable-static \
          CPPFLAGS="-I$PREFIX_DEPS/include" LDFLAGS="-L$PREFIX_DEPS/lib"
        make -j"$(nproc)" && make install
        cd ../..

        git clone --depth=1 https://gitlab.com/gnutls/gnutls.git gnutls
        cd gnutls
        ./bootstrap.sh
        ./configure --host="$TOOLCHAIN" --prefix="$PREFIX_DEPS" \
          --disable-shared --enable-static --disable-doc \
          CPPFLAGS="-I$PREFIX_DEPS/include" LDFLAGS="-L$PREFIX_DEPS/lib"
        make -j"$(nproc)" && make install
        cd ..

    - name: Cross‑compile optional deps
      run: |
        set -euxo pipefail
        cd deps/build

        git clone --depth=1 https://gitlab.freedesktop.org/fontconfig/fontconfig.git fontconfig
        cd fontconfig
        autoreconf -fi
        ./configure --host="$TOOLCHAIN" --prefix="$PREFIX_DEPS" \
          CPPFLAGS="-I$PREFIX_DEPS/include" LDFLAGS="-L$PREFIX_DEPS/lib"
        make -j"$(nproc)" && make install
        cd ..

        git clone --depth=1 https://github.com/harfbuzz/harfbuzz.git harfbuzz
        cd harfbuzz

        cat > cross.ini << 'EOF'
        [binaries]
        c = '${CC}'
        cxx = '${CXX}'
        ar = '${AR}'
        ranlib = '${RANLIB}'
        pkgconfig = 'pkg-config'

        [host_machine]
        system = 'windows'
        cpu_family = 'aarch64'
        cpu = 'aarch64'
        endian = 'little'
        EOF

        meson setup build --cross-file=cross.ini \
          -Dfontconfig=enabled -Dfreetype=enabled \
          --prefix="$PREFIX_DEPS"
        ninja -C build install
        cd ../..

        git clone --depth=1 https://gitlab.gnome.org/GNOME/libxml2.git libxml2
        cd libxml2
        mkdir -p build && cd build
        cat > cross_file.xml << 'EOF'
        <toolchain>
        <c compiler="@CC@" />
        <cxx compiler="@CXX@" />
        <ar program="@AR@" />
        <ranlib program="@RANLIB@" />
        </toolchain>
        EOF
        sed -i "s|@CC@|${CC}|g; s|@CXX@|${CXX}|g; s|@AR@|${AR}|g; s|@RANLIB@|${RANLIB}|g" cross_file.xml
        cmake -DCMAKE_TOOLCHAIN_FILE=cross_file.xml \
          -DCMAKE_INSTALL_PREFIX="$PREFIX_DEPS" \
          -DCMAKE_SYSTEM_NAME=Windows \
          -DLIBXML2_WITH_PIC=ON \
          -DLIBXML2_BUILD_TESTS=OFF ..
        cmake --build . --parallel "$(nproc)" && cmake --install .
        cd ../..

        git clone --depth=1 https://github.com/libsdl-org/SDL.git SDL2
        cd SDL2
        mkdir -p build && cd build
        cmake -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_SYSTEM_PROCESSOR=ARM64 \
          -DCMAKE_C_COMPILER="$CC" \
          -DCMAKE_CXX_COMPILER="$CXX" \
          -DCMAKE_INSTALL_PREFIX="$PREFIX_DEPS" \
          -DSDL_SHARED=OFF -DSDL_STATIC=ON ..
        cmake --build . --parallel "$(nproc)" && cmake --install .
        cd ../..

        git clone --depth=1 https://github.com/libusb/libusb.git libusb
        cd libusb
        mkdir -p build && cd build
        cmake -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_SYSTEM_PROCESSOR=ARM64 \
          -DCMAKE_INSTALL_PREFIX="$PREFIX_DEPS" \
          -DCMAKE_C_COMPILER="$CC" \
          -DCMAKE_CXX_COMPILER="$CXX" \
          -DENABLE_SHARED=OFF -DENABLE_STATIC=ON ..
        cmake --build . --parallel "$(nproc)" && cmake --install .
        cd ../..

        git clone --depth=1 https://gitlab.com/libtiff/libtiff.git libtiff
        cd libtiff
        mkdir -p build && cd build
        cmake -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_SYSTEM_PROCESSOR=ARM64 \
          -DCMAKE_INSTALL_PREFIX="$PREFIX_DEPS" \
          -DCMAKE_C_COMPILER="$CC" \
          -DCMAKE_CXX_COMPILER="$CXX" \
          -DBUILD_SHARED_LIBS=OFF ..
        cmake --build . --parallel "$(nproc)" && cmake --install .
        cd ../..

        git clone --depth=1 https://github.com/mm2/Little-CMS.git lcms2
        cd lcms2
        mkdir -p build && cd build
        cmake -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_SYSTEM_PROCESSOR=ARM64 \
          -DCMAKE_INSTALL_PREFIX="$PREFIX_DEPS" \
          -DCMAKE_C_COMPILER="$CC" \
          -DCMAKE_CXX_COMPILER="$CXX" \
          -DBUILD_SHARED_LIBS=OFF ..
        cmake --build . --parallel "$(nproc)" && cmake --install .
        cd ../..

        git clone --depth=1 https://github.com/gphoto/libgphoto2.git libgphoto2
        cd libgphoto2
        mkdir -p build && cd build
        cmake -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_SYSTEM_PROCESSOR=ARM64 \
          -DCMAKE_INSTALL_PREFIX="$PREFIX_DEPS" \
          -DCMAKE_C_COMPILER="$CC" \
          -DCMAKE_CXX_COMPILER="$CXX" \
          -DENABLE_SHARED=OFF -DENABLE_STATIC=ON ..
        cmake --build . --parallel "$(nproc)" && cmake --install .
        cd ../..

    - name: Clone Wine & patches
      run: |
        set -euxo pipefail
        git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 --branch v11.1 https://github.com/wine-staging/wine-staging.git wine-staging
        git clone https://github.com/Frogging-Family/wine-tkg-git.git wine-tkg

    - name: Apply Wine-Staging patches
      run: |
        set -euxo pipefail
        cd wine
        python3 ../wine-staging/staging/patchinstall.py --all --destdir="$(pwd)"
        cd ..

    - name: Apply wine-tkg patches
      run: |
        set -euxo pipefail
        cd wine
        mkdir -p rejects logs diffs
        > applied-patches.list
        BASE_TKG="../wine-tkg/wine-tkg-git/wine-tkg-patches"
        for root in \
          "${BASE_TKG}/mainline" \
          "${BASE_TKG}/staging" \
          "${BASE_TKG}/hotfixes" \
          "${BASE_TKG}/misc" \
          "${BASE_TKG}/proton" \
          "${BASE_TKG}/community-patches"; do
          if [ -d "$root" ]; then
            find "$root" -type f -name "*.patch" | sort | while read -r patchfile; do
              git diff > before.diff || true
              patch -p1 --forward < "$patchfile" > "logs/$(basename "$patchfile").out" 2>&1 || true
              if grep -q -E "Hunk FAILED|fail" "logs/$(basename "$patchfile").out"; then
                if ls *.rej 1> /dev/null 2>&1; then
                  mv *.rej "rejects/$(basename "$patchfile").rej" || true
                fi
              else
                echo "$patchfile" >> applied-patches.list
                git diff > "diffs/$(basename "$patchfile").diff" || true
              fi
            done
          fi
        done
        cd ..

    - name: Configure & compile Wine
      run: |
        set -euxo pipefail
        cd wine

        mkdir wine-tools-build
        cd wine-tools-build
        ../configure --enable-tools --disable-tests --disable-win16 --enable-archs=aarch64
        make -j"$(nproc)"
        cd ..

        mkdir build
        cd build

        export BUILD=aarch64-linux-gnu
        export HOST=aarch64-w64-mingw32
        export CC=aarch64-w64-mingw32-clang
        export CXX=aarch64-w64-mingw32-clang++
        export AR=aarch64-w64-mingw32-ar
        export LD=aarch64-w64-mingw32-lld
        export WINDRES=aarch64-w64-mingw32-windres
        export RANLIB=aarch64-w64-mingw32-ranlib

        export PKG_CONFIG_PATH="$PWD/../../deps/install/lib/pkgconfig:$PKG_CONFIG_PATH"
        export PKG_CONFIG_SYSROOT_DIR="$PWD/../../deps/install"
        export CFLAGS="-I$PWD/../../deps/install/include $CFLAGS"
        export LDFLAGS="-L$PWD/../../deps/install/lib $LDFLAGS"

        ../configure \
          --build="$BUILD" \
          --host="$HOST" \
          --with-mingw=clang \
          --with-wine-tools="../wine-tools-build" \
          --prefix=/usr \
          --enable-win64 \
          --enable-wow64 \
          --enable-archs=arm64ec,aarch64 \
          --disable-tests \
          --without-mono \
          --without-gecko \
          --with-freetype \
          --with-fontconfig \
          --with-alsa \
          --with-pulse \
          --with-sdl2 \
          --with-dbus \
          --with-vulkan \
          --with-lcms2 \
          --with-libtiff \
          --with-libusb
        make -j"$(nproc)"

    - name: Build DXVK
      run: |
        set -euxo pipefail
        git clone https://github.com/doitsujin/dxvk.git dxvk
        cd dxvk
        git submodule update --init --recursive
        pip3 install meson ninja
        meson setup build --cross-file=../wine/build/config/meson.cross.arm64ec.ini --prefix=/usr -Dbuild_tests=false
        ninja -C build install

    - name: Build VKD3D‑Proton
      run: |
        set -euxo pipefail
        git clone https://github.com/HansKristian-Work/vkd3d-proton.git vkd3d
        cd vkd3d
        git submodule update --init --recursive
        meson setup build --cross-file=../wine/build/config/meson.cross.arm64ec.ini --prefix=/usr -Dbuild_tests=false
        ninja -C build install

    - name: Package .wcp
      run: |
        set -euxo pipefail
        cd wine/build
        DESTDIR=$PWD/install make install
        cd install

        mkdir -p wcp/{bin,lib,share}
        cp -a usr/bin/* wcp/bin/ || true
        cp -a usr/lib/wine/* wcp/lib/ || true
        cp -a usr/share/* wcp/share/ || true
        cd wcp/bin && ln -sf wine64 wine
        find . -type f -exec chmod +x {} \;

        cat > profile.json << 'EOF'
        {
          "id":"wine-11.1-staging-tkg-arm64ec",
          "name":"Wine 11.1 Staging-TkG Arm64EC",
          "version":"11.1",
          "arch":"arm64ec",
          "files":{"bin":"bin/","lib":"lib/","share":"share/"}
        }
        EOF

        tar -cJf "$GITHUB_WORKSPACE/wine-11.1-staging-tkg-arm64ec.wcp" profile.json wcp

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-arm64ec-wcp
        path: wine-11.1-staging-tkg-arm64ec.wcp
