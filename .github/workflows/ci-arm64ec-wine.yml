name: Build ARM64EC Wine and Package .wcp file

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build_arm64ec_wine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup QEMU user emulation
        uses: docker/setup-qemu-action@v2
        with:
          platforms: aarch64

      - name: Install dependencies for Wine build
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            libtool \
            make \
            wget \
            curl \
            pkg-config \
            zlib1g-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libx11-dev \
            libxext-dev \
            libxrender-dev \
            libxml2-dev \
            libssl-dev \
            gcc-multilib \
            g++-multilib

      - name: Download LLVM MinGW toolchain for ARM64EC
        run: |
          # Скачиваем и распаковываем LLVM MinGW для ARM64EC
          wget https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-x86_64.tar.xz -O /tmp/llvm-mingw.tar.xz
          mkdir -p /opt/llvm-mingw
          tar -xf /tmp/llvm-mingw.tar.xz -C /opt/llvm-mingw

      - name: Set environment variables for sysroot and toolchain
        run: |
          # Устанавливаем переменные для использования LLVM MinGW toolchain
          export PATH="/opt/llvm-mingw/bin:$PATH"
          export CC=aarch64-w64-mingw32-clang
          export CXX=aarch64-w64-mingw32-clang++
          export AR=aarch64-w64-mingw32-ar
          export LD=aarch64-w64-mingw32-llvm-ld
          export RANLIB=aarch64-w64-mingw32-ranlib
          export PKG_CONFIG_PATH=/opt/llvm-mingw/aarch64-w64-mingw32/lib/pkgconfig
          export PKG_CONFIG_LIBDIR=$PKG_CONFIG_PATH
          export CFLAGS+=" --sysroot=/opt/llvm-mingw/aarch64-w64-mingw32"
          export LDFLAGS+=" --sysroot=/opt/llvm-mingw/aarch64-w64-mingw32"

      - name: Clone Wine repository
        run: |
          git clone --depth 1 --branch "wine-11.1" \
            https://gitlab.winehq.org/wine/wine.git wine-src

      - name: Configure Wine build
        working-directory: wine-src
        run: |
          # Настройка флагов и компилятора
          ./configure \
            --enable-archs=arm64ec,aarch64 \
            --host=arm64ec-w64-mingw32 \
            --with-mingw=clang \
            --without-x \
            --without-opengl \
            --without-vulkan \
            --without-gphoto2 \
            --without-freetype \
            --without-fontconfig \
            --without-alsa \
            --without-pulse \
            --without-sdl2 \
            --without-xinerama \
            --prefix=/usr

      - name: Build Wine
        working-directory: wine-src
        run: |
          make -j$(nproc)

      - name: Install Wine into artifact directory
        working-directory: wine-src
        run: |
          make DESTDIR=$PWD/artifact install

      - name: Create .wcp structure
        run: |
          mkdir -p wine-arm64ec-wcp/arch/arm64ec/bin
          mkdir -p wine-arm64ec-wcp/arch/arm64ec/lib
          mkdir -p wine-arm64ec-wcp/arch/arm64ec/etc

          cp -a wine-src/artifact/usr/bin/* wine-arm64ec-wcp/arch/arm64ec/bin/
          cp -a wine-src/artifact/usr/lib/* wine-arm64ec-wcp/arch/arm64ec/lib/

          cat << 'EOF' > wine-arm64ec-wcp/manifest.json
          {
            "name": "Wine11-ARM64EC",
            "version": "wine-11.1",
            "arch": "arm64ec",
            "runtime": "winlator-ludashi"
          }
          EOF

          echo "wine-11.1" > wine-arm64ec-wcp/version.txt

          cat << 'EOF' > wine-arm64ec-wcp/arch/arm64
