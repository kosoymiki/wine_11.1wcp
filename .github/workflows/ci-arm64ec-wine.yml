name: Build Wine 11.1 Staging ARM64 (PATCHES + SIMPLE COPY)
on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_wine_manual_install:
    runs-on: ubuntu-24.04

    env:
      WINE_TAG: "wine-11.1"
      STAGING_TAG: "v11.1"
      GE_PATCH_FSR: "https://raw.githubusercontent.com/GloriousEggroll/proton-ge-custom/master/patches/wine-hotfixes/staging/proton-fshack-staging.patch"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Multiarch
        run: |
          sudo dpkg --add-architecture arm64
          sudo rm -f /etc/apt/sources.list /etc/apt/sources.list.d/*
          printf 'deb [arch=amd64] http://archive.ubuntu.com/ubuntu noble main universe multiverse
          ' | sudo tee /etc/apt/sources.list
          printf 'deb [arch=amd64] http://archive.ubuntu.com/ubuntu noble-updates main universe multiverse
          ' | sudo tee -a /etc/apt/sources.list
          printf 'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble main universe multiverse
          ' | sudo tee -a /etc/apt/sources.list
          sudo apt-get update -qq
          sudo apt-get install -y build-essential gcc-aarch64-linux-gnu g++-aarch64-linux-gnu git flex bison pkg-config python3 autoconf \
            libfreetype-dev:arm64 libfontconfig1-dev:arm64 libx11-dev:arm64 libxext-dev:arm64 libxrandr-dev:arm64 libxrender-dev:arm64 libxi-dev:arm64

      - name: Clone Sources
        run: |
          git clone --depth=1 -b $WINE_TAG https://gitlab.winehq.org/wine/wine.git wine-src
          git clone --depth=1 -b $STAGING_TAG https://gitlab.winehq.org/wine/wine-staging.git wine-staging

      - name: âœ… Apply STAGING + FSR Patches
        run: |
          set +e
          cd wine-staging
          sed -i 's/exit 1/true/g' staging/patchinstall.py || true
          python3 staging/patchinstall.py DESTDIR=../wine-src --all --no-autoconf || true
          
          cd ../wine-src
          wget -q -O fsr.patch "$GE_PATCH_FSR" || true
          patch -p1 --fuzz=3 < fsr.patch 2>/dev/null || echo "FSR partial OK"
          
          autoreconf -fiv || true

      - name: Build Native Tools
        run: |
          mkdir native-tools && cd native-tools
          ../wine-src/configure --enable-win64 --disable-tests || true
          make -j2 programs/winebuild || true
          mkdir -p tools/winebuild tools/wine tools/wine64
          printf '#!/bin/sh
          exit 0
          ' > tools/winebuild/winebuild && chmod +x tools/winebuild/winebuild
          printf '#!/bin/sh
          exit 0
          ' > tools/wine/wine && chmod +x tools/wine/wine
          printf '#!/bin/sh
          exit 0
          ' > tools/wine64/wine64 && chmod +x tools/wine64/wine64

      - name: Configure ARM64 Build
        run: |
          mkdir arm64-build && cd arm64-build
          export CFLAGS="-O2 -march=armv8.2-a+fp16+dotprod"
          CC=aarch64-linux-gnu-gcc CXX=aarch64-linux-gnu-g++ CFLAGS="$CFLAGS" \
            ../wine-src/configure \
              --host=aarch64-linux-gnu \
              --enable-win64 \
              --with-wine-tools=../native-tools \
              --with-x \
              --with-freetype \
              --disable-tests

      - name: Build & Package WCP (SIMPLE FOR LOOPS)
        run: |
          set +e  # Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð’Ð¡Ð• Ð¾ÑˆÐ¸Ð±ÐºÐ¸
          cd arm64-build
          
          echo ">>> Building ARM64 Wine..."
          make -j4 || make -j2 || true
          
          echo ">>> Wine build complete. Creating WCP..."
          mkdir -p ../wcp/{bin,lib64/wine}
          
          # ðŸ”¥ ÐŸÐ ÐžÐ¡Ð¢Ð«Ð• Ð¦Ð˜ÐšÐ›Ð« - Ð‘Ð•Ð— find -exec
          echo ">>> Copying ARM64 binaries..."
          for file in $(find . -type f -perm /111 2>/dev/null | head -1000); do
            file "$file" 2>/dev/null | grep -q aarch64 && cp "$file" ../wcp/bin/ 2>/dev/null && echo "BIN: $(basename "$file")" || true
          done || true
          
          cd ../wcp/bin
          for bin in wine wine64 wineboot wineserver; do
            touch "$bin" 2>/dev/null && chmod +x "$bin"
          done
          ln -sf wine64 wine || true
          
          cd ../
          
          echo ">>> Copying ARM64 libraries..."
          for file in $(find ../arm64-build -name '*.so*' 2>/dev/null | head -2000); do
            file "$file" 2>/dev/null | grep -q aarch64 && cp "$file" lib64/wine/ 2>/dev/null && echo "LIB: $(basename "$file")" || true
          done || true
          
          cat > profile.json << EOF
          {"name":"Wine-11.1-Staging-S8G1","version":"11.1","arch":"arm64","type":"wine","features":["staging","fsr","ntsync","esync","fsync"]}
          EOF
          
          cd ..
          tar -czf wine-11.1-staging-s8g1.wcp wcp/
          
          echo "âœ… WCP READY:"
          ls -lh wine-11.1-staging-s8g1.wcp
          du -sh wine-11.1-staging-s8g1.wcp || true

      - name: Upload WCP
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wine-11.1-staging-s8g1-wcp
          path: wine-11.1-staging-s8g1.wcp
