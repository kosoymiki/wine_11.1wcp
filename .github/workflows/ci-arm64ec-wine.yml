name: Build Wine 11.1 Staging ARM64EC PHAT wcp

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm

    defaults:
      run:
        shell: bash

    env:
      WINE_TAG: "wine-11.1"
      STAGING_TAG: "v11.1"
      LLVM_MINGW_VERSION: "20251216"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential wget git python3 gettext \
            pkgconf cmake ninja-build meson \
            autoconf automake libtool \
            patchutils bison flex \
            libc6-dev libfreetype-dev libfontconfig-dev \
            libsdl2-dev libpulse-dev libasound2-dev \
            libdbus-1-dev libdb-dev \
            libavcodec-dev libavformat-dev libavutil-dev libswscale-dev \
            libudev-dev ca-certificates \
            zip rsync file xz-utils
          sudo ln -sf /usr/bin/pkgconf /usr/local/bin/pkg-config || true

      - name: Setup llvm mingw
        run: |
          set -euxo pipefail
          ROOT="$PWD"
          LLVM_DIR="$ROOT/llvm-mingw"

          rm -rf "$LLVM_DIR"
          mkdir -p "$LLVM_DIR"

          TARBALL="llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/${TARBALL}"
          tar -xJf "$TARBALL" -C "$LLVM_DIR" --strip-components=1
          rm -f "$TARBALL"

          # Делает PATH доступным в следующих steps
          echo "$LLVM_DIR/bin" >> "$GITHUB_PATH"  # GitHub workflow command :contentReference[oaicite:2]{index=2}

          # ВАЖНО: ls|head под pipefail даёт Broken pipe -> не валим job
          ls -la "$LLVM_DIR/bin" | head -n 60 || true

      - name: Verify cross compiler exists
        run: |
          set -euxo pipefail
          ROOT="$PWD"
          export PATH="$ROOT/llvm-mingw/bin:$PATH"

          command -v aarch64-w64-mingw32-clang
          aarch64-w64-mingw32-clang --version
          echo 'int main(void){return 0;}' > /tmp/test.c
          aarch64-w64-mingw32-clang -o /tmp/test.exe /tmp/test.c -Wl,--no-undefined
          file /tmp/test.exe

      - name: Clone wine and staging
        run: |
          set -euxo pipefail
          rm -rf wine wine-staging

          git clone https://gitlab.winehq.org/wine/wine.git wine
          ( cd wine && git fetch --tags && git checkout -qf "$WINE_TAG" )

          git clone https://gitlab.winehq.org/wine/wine-staging.git wine-staging
          ( cd wine-staging && git fetch --tags && git checkout -qf "$STAGING_TAG" )

      - name: Apply staging patches
        run: |
          set -euxo pipefail
          ROOT="$PWD"

          python3 wine-staging/staging/patchinstall.py -d "$ROOT/wine" -a --no-autoconf

          cd "$ROOT/wine"
          autoreconf -fiv
          ./tools/make_requests

      - name: Build native wine tools minimal
        run: |
          set -euxo pipefail
          ROOT="$PWD"

          # Чистим прошлые результаты
          rm -rf wine-tools wine/build-tools
          mkdir -p wine-tools/bin wine/build-tools

          # Собираем только нужные исполняемые файлы
          cd wine/build-tools

          # Конфигурация должна быть минимальной, без ненужных зависимостей
          ../configure \
          --disable-tests \
          --disable-win16 \
          --without-x \
          --without-vulkan \
          --without-alsa \
          --without-pulse \
          --without-sdl2

          # Собираем только конкретные инструменты
          make -j"$(nproc)" \
          tools/winebuild/winebuild \
          tools/widl/widl \
          tools/wrc/wrc \
          tools/makedep/makedep \
          tools/winegcc/winegcc

          # Устанавливаем ровно те бинарники, которые нужны
          install -D -m 755 tools/winebuild/winebuild "$ROOT/wine-tools/bin/winebuild"
          install -D -m 755 tools/widl/widl           "$ROOT/wine-tools/bin/widl"
          install -D -m 755 tools/wrc/wrc             "$ROOT/wine-tools/bin/wrc"
          install -D -m 755 tools/makedep/makedep     "$ROOT/wine-tools/bin/makedep"
          install -D -m 755 tools/winegcc/winegcc     "$ROOT/wine-tools/bin/winegcc"


          # Проверка результатов
          ls -l "$ROOT/wine-tools/bin"
          test -x "$ROOT/wine-tools/bin/winebuild"
          test -x "$ROOT/wine-tools/bin/widl"
          test -x "$ROOT/wine-tools/bin/wrc"
          test -x "$ROOT/wine-tools/bin/makedep"
          test -x "$ROOT/wine-tools/bin/winegcc"


      - name: Configure wine cross arm64ec
        run: |
          set -euxo pipefail
          ROOT="$PWD"
          export PATH="$ROOT/llvm-mingw/bin:$PATH"

          rm -rf "$ROOT/wine-build"
          mkdir -p "$ROOT/wine-build"
          cd "$ROOT/wine-build"

          export CC=aarch64-w64-mingw32-clang
          export CXX=aarch64-w64-mingw32-clang++
          export AR=aarch64-w64-mingw32-ar
          export RANLIB=aarch64-w64-mingw32-ranlib
          export STRIP=aarch64-w64-mingw32-strip

          "$ROOT/wine/configure" \
            --host=aarch64-w64-mingw32 \
            --with-wine-tools="$ROOT/wine-tools/bin" \
            --prefix=/usr \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64 \
            --disable-tests \
            --without-vulkan

      - name: Build wine
        run: |
          set -euxo pipefail
          ROOT="$PWD"
          cd "$ROOT/wine-build"

          make -j"$(nproc)"
          rm -rf "$ROOT/wine-install"
          DESTDIR="$ROOT/wine-install" make install

      - name: Build mesa turnip
        run: |
          set -euxo pipefail
          ROOT="$PWD"
          rm -rf "$ROOT/external"
          mkdir -p "$ROOT/external"

          git clone --depth 1 https://github.com/whitebelyash/mesa-tu8 "$ROOT/external/mesa-src"
          meson setup "$ROOT/external/mesa-build" "$ROOT/external/mesa-src" \
            -Dvulkan-drivers=turnip \
            -Dplatforms=none \
            -Dbuildtype=release
          ninja -C "$ROOT/external/mesa-build"
          DESTDIR="$ROOT/external/mesa-install" ninja -C "$ROOT/external/mesa-build" install

      - name: Unpack dxvk and vkd3d
        run: |
          set -euxo pipefail
          ROOT="$PWD"
          mkdir -p "$ROOT/external/dxvk" "$ROOT/external/vkd3d"

          wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/DXVK-GPLASYNC-ARM64EC/dxvk-gplasync-arm64ec-2.7.1-1.wcp" -O /tmp/dxvk.wcp
          tar -xJf /tmp/dxvk.wcp -C "$ROOT/external/dxvk"

          wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/VKD3D-PROTON-ARM64EC/vkd3d-proton-arm64ec-3.0b.wcp" -O /tmp/vkd3d.wcp
          tar -xJf /tmp/vkd3d.wcp -C "$ROOT/external/vkd3d"

      - name: Unpack fexcore
        run: |
          set -euxo pipefail
          ROOT="$PWD"
          mkdir -p "$ROOT/external/fexcore"
          wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/FEXCore/FEXCore-2601.wcp" -O /tmp/fexcore.wcp
          tar -xJf /tmp/fexcore.wcp -C "$ROOT/external/fexcore"

      - name: Assemble wcp
        run: |
          set -euxo pipefail
          ROOT="$PWD"
          rm -rf "$ROOT/wcp"
          mkdir -p "$ROOT/wcp"/{bin,share/wine,dxvk/arm64ec,vkd3d/arm64ec,mesa/turnip}
          mkdir -p "$ROOT/wcp/lib/wine"/{aarch64-unix,aarch64-windows,arm64ec-windows}

          # wine binaries
          cp -v "$ROOT/wine-install/usr/bin/"{wine,wine64,wineboot,wineserver} "$ROOT/wcp/bin/" || true

          # runtime libs (структура может отличаться, поэтому rsync с || true)
          rsync -a "$ROOT/wine-install/usr/lib/" "$ROOT/wcp/lib/wine/aarch64-unix/" || true

          # dxvk vkd3d
          rsync -a "$ROOT/external/dxvk/" "$ROOT/wcp/dxvk/arm64ec/" || true
          rsync -a "$ROOT/external/vkd3d/" "$ROOT/wcp/vkd3d/arm64ec/" || true

          # turnip
          cp -v "$ROOT/external/mesa-install/usr/local/lib/"* "$ROOT/wcp/mesa/turnip/" || true

          # fexcore
          rsync -a "$ROOT/external/fexcore/" "$ROOT/wcp/lib/wine/arm64ec-windows/" || true

          cat > "$ROOT/wcp/env.sh" <<'EOF'
          #!/bin/sh
          export WINEDEBUG=-all
          export DXVK_ASYNC=1
          export MESA_LOADER_DRIVER_OVERRIDE=turnip
          export WINEPREFIX=~/.wine
          export WINEARCH=win64
          EOF
          chmod +x "$ROOT/wcp/env.sh"

          cat > "$ROOT/wcp/info.json" <<EOF
          {"name":"Wine-11.1-Staging-ARM64EC","version":"$WINE_TAG","arch":"arm64ec","type":"phat"}
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-arm64ec-phat
          path: wcp
