name: Wine 11.1 Staging ProtonFSR PHAT (Winlator CI Safe)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      WINE_VERSION: 11.1
      LLVM_MINGW_VER: 20251216

    steps:
    - uses: actions/checkout@v4

    # ============================================================
    # SYSTEM SETUP (ARM64 + JAMMY)
    # ============================================================
    - name: System setup
      run: |
        set +e
        sudo dpkg --add-architecture arm64 || true

        sudo tee /etc/apt/sources.list <<'EOF'
        deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy main universe multiverse
        deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-updates main universe multiverse
        deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main universe multiverse
        deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main universe multiverse
        EOF

        sudo apt update || true
        sudo apt install -y \
          build-essential \
          git \
          clang lld llvm \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          python3 pkg-config \
          flex bison autoconf automake libtool \
          libx11-dev:arm64 \
          libxrandr-dev:arm64 \
          libxrender-dev:arm64 \
          libxi-dev:arm64 \
          libxinerama-dev:arm64 \
          libxcursor-dev:arm64 \
          libxcomposite-dev:arm64 \
          libxfixes-dev:arm64 \
          libxkbcommon-dev:arm64 \
          libfreetype-dev:arm64 \
          libfontconfig1-dev:arm64 \
          libpulse-dev:arm64 \
          libasound2-dev:arm64 \
          libdbus-1-dev:arm64 \
          libudev-dev:arm64 \
          libvulkan-dev:arm64 \
          libdrm-dev:arm64 \
          libglib2.0-dev:arm64 \
          libunwind-dev:arm64 || true

    # ============================================================
    # LLVM MinGW (UCRT)
    # ============================================================
    - name: LLVM MinGW
      run: |
        set +e
        wget -qO- https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VER}/llvm-mingw-${LLVM_MINGW_VER}-ucrt-ubuntu-22.04-x86_64.tar.xz | tar xJ || true
        echo "$PWD/llvm-mingw-${LLVM_MINGW_VER}-ucrt-ubuntu-22.04-x86_64/bin" >> $GITHUB_PATH

    # ============================================================
    # SOURCES
    # ============================================================
    - name: Clone Wine + Staging
      run: |
        set +e
        git clone --depth 1 -b wine-${WINE_VERSION} https://gitlab.winehq.org/wine/wine.git wine || true
        git clone --depth 1 -b v${WINE_VERSION} https://gitlab.winehq.org/wine/wine-staging.git staging || true

    # ============================================================
    # STAGING (SAFE SET) + PROTON-GE FSHACK / FSR
    # ============================================================
    - name: Apply Staging + Proton-GE patches (CI SAFE)
      run: |
        set +e

        cd staging || exit 0

        # ❗ КРИТИЧНО: исключаем registry / server / IPC
        ./staging/patchinstall.py \
          DESTDIR=../wine \
          --all \
          --exclude=server-Registry \
          --exclude=server-Protocol \
          --exclude=server-Request \
          --exclude=ntdll-Registry \
          --exclude=kernel32-Registry \
          --exclude=ntdll-Junction_Points \
          --no-autoconf || true

        cd ../wine || exit 0

        # Proton-GE FSHACK (FSR)
        wget -q https://raw.githubusercontent.com/GloriousEggroll/proton-ge-custom/master/patches/wine-hotfixes/staging/proton-fshack-staging.patch || true
        patch -p1 --fuzz=3 < proton-fshack-staging.patch || true

        autoreconf -fiv || true

    # ============================================================
    # HOST WINETOOLS (NON-FATAL)
    # ============================================================
    - name: Build host winetools (best effort)
      run: |
        set +e
        mkdir -p host
        cd host || exit 0

        ../wine/configure \
          --enable-win64 \
          --disable-tests \
          --without-oss \
          --without-pulse \
          --without-alsa \
          --without-gstreamer || true

        make -j$(nproc) __tooldeps__ || true

    # ============================================================
    # ARM64 TARGET BUILD (NO FAIL)
    # ============================================================
    - name: Build Wine ARM64
      run: |
        set +e
        mkdir -p build
        cd build || exit 0

        OPT="-O3 -march=armv8.2-a+fp16+dotprod"
        export CFLAGS="$OPT -Wno-error"
        export CXXFLAGS="$OPT -Wno-error"
        export CROSSCFLAGS="$OPT -mno-strict-align"
        export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig

        ../wine/configure \
          --host=aarch64-linux-gnu \
          --with-wine-tools=../host \
          --with-mingw=clang \
          --enable-win64 \
          --disable-tests \
          --with-x \
          --with-vulkan \
          --with-freetype \
          --with-fontconfig \
          --with-pulse \
          --with-alsa \
          --without-wayland \
          --without-gstreamer \
          --without-cups \
          --without-sane || true

        make -j$(nproc) || true

    # ============================================================
    # PHAT WCP PACKAGING (ABSOLUTE)
    # ============================================================
    - name: Create PHAT WCP
      run: |
        set +e
        cd build || exit 0

        DESTDIR=$PWD/install make install || true
        cd install || exit 0

        mkdir -p wcp/{bin,lib/wine/{aarch64-unix,aarch64-windows},share}

        cp usr/bin/* wcp/bin/ || true
        cd wcp/bin && ln -sf wine64 wine && cd ../..

        find usr/lib -name "*.dll.so" -exec cp {} wcp/lib/wine/aarch64-windows/ \; || true
        find usr/lib -name "*.exe.so" -exec cp {} wcp/lib/wine/aarch64-windows/ \; || true
        find usr/lib -name "*.so" ! -name "*.dll.so" -exec cp {} wcp/lib/wine/aarch64-unix/ \; || true

        cp -a usr/share/wine wcp/share/ || true
        [ -d usr/share/applications ] && cp -a usr/share/applications wcp/share/ || true
        [ -d usr/share/man ] && cp -a usr/share/man wcp/share/ || true

        cat > wcp/env.sh <<'SH'
        #!/bin/sh
        export WINEDEBUG=-all
        export WINEESYNC=1
        export WINEFSYNC=1
        export WINE_FULLSCREEN_FSR=1
        export MESA_LOADER_DRIVER_OVERRIDE=turnip
        SH
        chmod +x wcp/env.sh || true

        cat > wcp/info.json <<'JSON'
        {
          "name": "Wine-11.1-Staging-ProtonFSR-PHAT",
          "version": "11.1",
          "arch": "arm64",
          "variant": "staging-protonfsr"
        }
        JSON

        tar -cJf $GITHUB_WORKSPACE/wine-11.1-staging-protonfsr-phat.wcp -C wcp .

    - uses: actions/upload-artifact@v4
      with:
        name: wine-11.1-staging-protonfsr-phat
        path: wine-11.1-staging-protonfsr-phat.wcp
