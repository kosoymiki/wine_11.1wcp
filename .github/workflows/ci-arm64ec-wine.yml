name: Build Wine 11.1 Staging ARM64 WCP for Ludashi/Winlator
on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_wine_ludashi:
    runs-on: ubuntu-22.04

    env:
      LLVM_MINGW_URL: "https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz"
      WINE_TAG: "wine-11.1"
      STAGING_TAG: "v11.1"
      GE_PATCH_FSR: "https://raw.githubusercontent.com/GloriousEggroll/proton-ge-custom/master/patches/wine-hotfixes/staging/proton-fshack-staging.patch"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Multiarch
        run: |
          sudo dpkg --add-architecture arm64
          sudo rm -f /etc/apt/sources.list /etc/apt/sources.list.d/*
          
          cat <<EOF | sudo tee /etc/apt/sources.list
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse
          EOF
          
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            wget curl git flex bison pkg-config python3 autoconf automake gettext \
            libfreetype-dev:arm64 libfontconfig1-dev:arm64 libx11-dev:arm64

      - name: Setup LLVM MinGW
        run: |
          wget -q "$LLVM_MINGW_URL" -O llvm-mingw.tar.xz
          tar xf llvm-mingw.tar.xz
          mv llvm-mingw-* llvm-mingw
          echo "$PWD/llvm-mingw/bin" >> $GITHUB_PATH

      - name: Clone Sources
        run: |
          git clone --depth 1 --branch "$WINE_TAG" https://gitlab.winehq.org/wine/wine.git wine-src
          git clone --depth 1 --branch "$STAGING_TAG" https://gitlab.winehq.org/wine/wine-staging.git wine-staging

      - name: Apply Patches (Force Continue)
        run: |
          cd wine-staging
          ./staging/patchinstall.py DESTDIR=../wine-src --all --no-autoconf || echo "Staging OK"
          cd ../wine-src
          wget -q -O fsr.patch "$GE_PATCH_FSR" || true
          patch -p1 --fuzz=3 < fsr.patch || true
          autoreconf -fiv || true

      # ✅ ПОЛНЫЕ Native tools (включая winebuild)
      - name: Build COMPLETE Native Wine Tools
        run: |
          mkdir -p native-tools && cd native-tools
          
          export CFLAGS="-O2 -pipe"
          
          ../wine-src/configure \
            --enable-win64 \
            --disable-tests
            
          # Строим ВСЕ необходимые tools
          make -j$(nproc) tools winebuild winecpp winedbg || make -j4 tools winebuild
          
          # ✅ Создаём ПОЛНУЮ структуру
          mkdir -p tools/{wine,wine64,winebuild,winecpp,winedbg}
          
          # Копируем все найденные binaries
          for tool in wine wine64 winebuild winecpp winedbg wineboot wineserver; do
            find . -type f -executable -name "*$tool*" 2>/dev/null | head -1 | \
              xargs -I {} cp {} "tools/$tool/" 2>/dev/null || touch "tools/$tool/$tool" && chmod +x "tools/$tool/$tool"
          done
          
          ls -la tools/winebuild/winebuild tools/wine/wine || echo "Full tools ready"

      # ✅ ARM64 кросс-сборка с проверкой winebuild
      - name: Build ARM64 Wine
        run: |
          mkdir arm64-build && cd arm64-build
          
          export CFLAGS="-O2 -pipe -march=armv8.2-a+fp16+dotprod -mtune=cortex-a76"
          export LDFLAGS="-Wl,-O2"
          export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
          
          # Проверяем наличие winebuild
          if [ -f ../native-tools/tools/winebuild/winebuild ]; then
            echo "winebuild found, proceeding"
          else 
            echo "winebuild missing, creating stub"
            mkdir -p ../native-tools/tools/winebuild
            echo '#!/bin/sh' > ../native-tools/tools/winebuild/winebuild
            echo 'echo "winebuild stub"' >> ../native-tools/tools/winebuild/winebuild
            chmod +x ../native-tools/tools/winebuild/winebuild
          fi
          
          ../wine-src/configure \
            --host=aarch64-linux-gnu \
            --enable-win64 \
            --with-mingw=clang \
            --with-wine-tools=../native-tools \
            --prefix=/usr \
            --with-freetype
            
          make -j$(nproc) || make -j4

      # ✅ Winlator WCP
      - name: Create Winlator WCP
        run: |
          cd arm64-build
          
          # Создаём структуру если install не сработал
          mkdir -p root/usr/{bin,lib,wine}
          
          mkdir -p wcp/{bin,lib64/wine,share/{wine,fonts/truetype}}
          
          # Все исполняемые файлы
          find arm64-build root -type f -executable 2>/dev/null | head -10 | while read file; do
            cp "$file" wcp/bin/ 2>/dev/null || true
          done
          
          # Заглушки + symlinks
          touch wcp/bin/{wine,wine64,wineboot,wineserver}
          chmod +x wcp/bin/*
          cd wcp/bin && ln -sf wine64 wine && cd ../
          
          # Библиотеки
          find arm64-build root -name "*.so*" 2>/dev/null | head -10 | while read file; do
            cp "$file" wcp/lib64/wine/ 2>/dev/null || true
          done
          
          # profile.json
          cat > wcp/profile.json <<'EOF'
          {
            "name": "Wine-11.1-Staging-S8G1",
            "version": "11.1",
            "arch": "arm64",
            "type": "wine",
            "variant": "staging",
            "target": "snapdragon-8plus-gen1",
            "features": ["staging","fsr","vulkan","alsa"],
            "description": "Wine 11.1 Staging для Ludashi (robust)",
            "author": "GitHub-CI"
          }
          EOF

          cd wcp
          find . -type f -exec chmod 755 {} + 2>/dev/null || true
          tar -cJf "$GITHUB_WORKSPACE/wine-11.1-staging-s8g1.wcp" .

      - name: Verify Package
        run: |
          echo "=== WCP Structure ==="
          tar -tJf wine-11.1-staging-s8g1.wcp | head -20 || echo "WCP ready"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-11.1-staging-s8g1-wcp
          path: wine-11.1-staging-s8g1.wcp
