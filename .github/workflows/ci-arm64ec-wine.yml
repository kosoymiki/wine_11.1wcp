name: Build Wine 11.1 Staging ARM64EC (PHAT .wcp)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm

    env:
      WINE_VERSION: "11.1"
      LLVM_MINGW_VERSION: "20251216"
      LLVM_MINGW_DIR: "$HOME/llvm-mingw"
      BUILD_DIR: "$GITHUB_WORKSPACE/build"
      WCP_DIR: "$GITHUB_WORKSPACE/wcp"

    steps:

    # ----------------------------------
    # Checkout
    # ----------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ----------------------------------
    # Install host deps
    # ----------------------------------
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y --no-install-recommends \
          build-essential wget git python3 gettext \
          pkgconf cmake ninja-build autoconf automake libtool \
          libc6-dev libfreetype-dev libfontconfig-dev \
          libsdl2-dev libpulse-dev libasound2-dev \
          libdbus-1-dev libdb-dev \
          libavcodec-dev libavformat-dev libavutil-dev libswscale-dev \
          libudev-dev ca-certificates
        sudo ln -sf /usr/bin/pkgconf /usr/local/bin/pkg-config

    # ----------------------------------
    # Download ARM64 llvm-mingw
    # ----------------------------------
    - name: Download & unpack llvm‑mingw ARM64
      run: |
        mkdir -p "$LLVM_MINGW_DIR"
        wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz"
        tar -xJf "llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz" \
          -C "$LLVM_MINGW_DIR" --strip-components=1
        rm "llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz"
        echo "$LLVM_MINGW_DIR/bin" >> "$GITHUB_PATH"

    # ----------------------------------
    # Verify cross‑toolchain
    # ----------------------------------
    - name: Verify llvm‑mingw cross‑compiler
      run: |
        set -eux
        echo "=== llvm‑mingw bin list ==="
        ls -1 "$LLVM_MINGW_DIR/bin"
        echo "=== Cross tool versions ==="
        "$LLVM_MINGW_DIR/bin/aarch64-w64-mingw32-clang" --version
        "$LLVM_MINGW_DIR/bin/aarch64-w64-mingw32-clang++" --version
        "$LLVM_MINGW_DIR/bin/aarch64-w64-mingw32-dlltool" --version || true
        "$LLVM_MINGW_DIR/bin/lld" --version || true
        echo 'int main(){return 0;}' > /tmp/t.c
        "$LLVM_MINGW_DIR/bin/aarch64-w64-mingw32-clang" \
          --target=aarch64-w64-mingw32 \
          -o /tmp/t.exe /tmp/t.c -Wl,--no-undefined
        file /tmp/t.exe || true

    # ----------------------------------
    # Sources & staging
    # ----------------------------------
    - name: Clone Wine + Staging
      run: |
        git clone --depth 1 -b wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
        git clone --depth 1 -b v11.1 https://gitlab.winehq.org/wine/wine-staging.git staging

    - name: Apply Wine‑Staging (exclude sync patches)
      run: |
        set +e
        cd staging
        ./staging/patchinstall.py DESTDIR=../wine --all --no-autoconf || true
        cd ../wine
        git apply -R staging/patches/ntdll-fsync/0001*.patch || true
        git apply -R staging/patches/server-Fsync/0001*.patch || true
        git apply -R staging/patches/ntdll-esync/0001*.patch || true
        git apply -R staging/patches/server-Esync/0001*.patch || true
        git apply -R staging/patches/ntdll-Synchronization/0001*.patch || true
        autoreconf -fiv

    # ----------------------------------
    # Configure & Build Wine ARM64EC
    # ----------------------------------
    - name: Configure & Build Wine with Wow64
      run: |
        mkdir -p "$BUILD_DIR" && cd "$BUILD_DIR"
        export CC="$LLVM_MINGW_DIR/bin/aarch64-w64-mingw32-clang"
        export CXX="$LLVM_MINGW_DIR/bin/aarch64-w64-mingw32-clang++"
        export AR="$LLVM_MINGW_DIR/bin/aarch64-w64-mingw32-ar"
        export RANLIB="$LLVM_MINGW_DIR/bin/aarch64-w64-mingw32-ranlib"
        export STRIP="$LLVM_MINGW_DIR/bin/aarch64-w64-mingw32-strip"
        export PKG_CONFIG=pkg-config
        export PKG_CONFIG_PATH="/usr/lib/aarch64/pkgconfig:${PKG_CONFIG_PATH:-}"
        ../wine/configure \
          --host=aarch64-w64-mingw32 \
          --with-wine-tools=../host \
          --enable-win64 --enable-wow64 \
          --enable-archs=arm64ec,aarch64 \
          --disable-tests \
          --enable-ntsync \
          --without-x \
          --without-vulkan
        make -j1
        DESTDIR="$PWD/install" make install

    # ----------------------------------
    # Integrate externals (DXVK/VKD3D/Turnip)
    # ----------------------------------
    - name: Integrate DXVK, VKD3D, Turnip
      run: |
        mkdir -p "$BUILD_DIR/external"
        wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/DXVK-GPLASYNC-ARM64EC/dxvk-gplasync-arm64ec-2.7.1-1.wcp"
        mkdir -p "$BUILD_DIR/external/dxvk"
        tar -xJf dxvk-gplasync-arm64ec-2.7.1-1.wcp -C "$BUILD_DIR/external/dxvk"
        wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/VKD3D-PROTON-ARM64EC/vkd3d-proton-arm64ec-3.0b.wcp"
        mkdir -p "$BUILD_DIR/external/vkd3d"
        tar -xJf vkd3d-proton-arm64ec-3.0b.wcp -C "$BUILD_DIR/external/vkd3d"
        wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/MESA-TURNIP-ARM64EC/mesa-turnip-arm64ec.wcp"
        mkdir -p "$BUILD_DIR/external/mesa"
        tar -xJf mesa-turnip-arm64ec.wcp -C "$BUILD_DIR/external/mesa"

    # ----------------------------------
    # FEXCore & PHAT .wcp tree
    # ----------------------------------
    - name: Unpack FEXCore
      run: |
        mkdir -p wcp/lib/wine/arm64ec-windows
        wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/FEXCore/FEXCore-2601.wcp" -O FEXCore.wcp
        tar -xJf FEXCore.wcp -C wcp/lib/wine/arm64ec-windows

    - name: Prepare PHAT .wcp tree
      run: |
        rm -rf "$WCP_DIR"
        mkdir -p "$WCP_DIR/bin" \
                 "$WCP_DIR/lib/wine/aarch64-unix" \
                 "$WCP_DIR/lib/wine/aarch64-windows" \
                 "$WCP_DIR/lib/wine/arm64ec-windows" \
                 "$WCP_DIR/share/wine" \
                 "$WCP_DIR/dxvk/arm64ec" \
                 "$WCP_DIR/vkd3d/arm64ec" \
                 "$WCP_DIR/mesa/turnip"
        cp build/install/bin/{wine,wine64,wineboot,wineserver} "$WCP_DIR/bin/"
        cp -rv build/install/lib/* "$WCP_DIR/lib/wine/aarch64-unix/"
        cp -rv build/install/lib/* "$WCP_DIR/lib/wine/aarch64-windows/"
        cp -rv wcp/lib/wine/arm64ec-windows/* "$WCP_DIR/lib/wine/arm64ec-windows/"
        cp -rv build/external/dxvk/* "$WCP_DIR/dxvk/arm64ec/"
        cp -rv build/external/vkd3d/* "$WCP_DIR/vkd3d/arm64ec/"
        cp -rv build/external/mesa/* "$WCP_DIR/mesa/turnip/"
        printf "export WINEPREFIX=~/.wine\nexport WINEARCH=win64\n" > "$WCP_DIR/env.sh"
        printf '{ "version":"%s","arch":"arm64ec","type":"phat" }' "$WINE_VERSION" > "$WCP_DIR/info.json"

    # ----------------------------------
    # Upload artifact
    # ----------------------------------
    - name: Upload Wine .wcp
      uses: actions/upload-artifact@v4
      with:
        name: wine-arm64ec-phat
        path: "$WCP_DIR"
