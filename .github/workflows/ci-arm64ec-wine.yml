name: Build Wine 11.1 Staging ARM64 WCP for Ludashi/Winlator
on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_wine_ludashi:
    runs-on: ubuntu-22.04

    env:
      LLVM_MINGW_URL: "https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz"
      WINE_TAG: "wine-11.1"
      STAGING_TAG: "v11.1"
      GE_PATCH_FSR: "https://raw.githubusercontent.com/GloriousEggroll/proton-ge-custom/master/patches/wine-hotfixes/staging/proton-fshack-staging.patch"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Multiarch + Complete Dependencies
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            # Build essentials
            build-essential gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            wget curl git flex bison pkg-config python3 autoconf automake \
            # Gettext для переводов
            gettext \
            # X11 + OpenGL + Vulkan (критично!)
            libx11-dev:arm64 libxrandr-dev:arm64 libxrender-dev:arm64 libxext-dev:arm64 \
            libgl1-mesa-dev:arm64 libglu1-mesa-dev:arm64 libvulkan-dev:arm64 \
            libxfixes-dev:arm64 libxinerama-dev:arm64 libxcursor-dev:arm64 libxi-dev:arm64 \
            # Audio (ALSA + PulseAudio)
            libasound2-dev:arm64 libpulse-dev:arm64 \
            # GStreamer (видео)
            libgstreamer1.0-dev:arm64 libgstreamer-plugins-base1.0-dev:arm64 \
            # Core libs
            libfreetype-dev:arm64 libfontconfig1-dev:arm64 libdbus-1-dev:arm64 \
            libgnutls28-dev:arm64 libudev-dev:arm64 libglib2.0-dev:arm64 \
            libxkbcommon-dev:arm64 libsdl2-dev:arm64 libunwind-dev:arm64 \
            # USB + Cameras (опционально)
            libusb-1.0-0-dev:arm64 libv4l-dev:arm64

      - name: Setup LLVM MinGW
        run: |
          wget -q "$LLVM_MINGW_URL" -O llvm-mingw.tar.xz
          tar xf llvm-mingw.tar.xz
          mv llvm-mingw-* llvm-mingw
          echo "$PWD/llvm-mingw/bin" >> $GITHUB_PATH

      - name: Clone Sources
        run: |
          git clone --depth 1 --branch "$WINE_TAG" https://gitlab.winehq.org/wine/wine.git wine-src
          git clone --depth 1 --branch "$STAGING_TAG" https://gitlab.winehq.org/wine/wine-staging.git wine-staging

      - name: Apply Staging + FSR Patches
        run: |
          cd wine-staging
          ./staging/patchinstall.py DESTDIR=../wine-src --all --no-autoconf
          cd ../wine-src
          wget -q -O fsr.patch "$GE_PATCH_FSR"
          patch -p1 --fuzz=3 < fsr.patch || echo "FSR partial apply"
          autoreconf -fiv

      # ✅ ПРАВИЛЬНАЯ структура native tools
      - name: Build COMPLETE native Wine tools (x86_64)
        run: |
          mkdir -p native-tools
          cd native-tools
          
          export CFLAGS="-O2 -pipe"
          export LDFLAGS="-Wl,-O2"
          
          # Полная конфигурация для tools
          ../wine-src/configure \
            --enable-win64 \
            --with-x \
            --with-freetype \
            --disable-tests
            
          # Строим ВСЕ tools
          make -j$(nproc) tools wineboot wineserver winecpp winedbg
          
          # ✅ Создаём правильную структуру
          mkdir -p tools/wine tools/wine64
          cp tools/wine/wine tools/wine/wine
          cp tools/wine64/wine64 tools/wine64/wine64
          cp tools/wineboot/wineboot tools/
          cp tools/wineserver/wineserver tools/
          
          # Проверяем структуру
          find tools -name wine -o -name wine64 -o -name wineserver | head -5
          ls -la tools/wine/wine tools/wine64/wine64 || echo "CRITICAL: Tools missing!"

      # ✅ Кросс-сборка ARM64
      - name: Configure + Build Wine ARM64
        run: |
          mkdir arm64-build && cd arm64-build
          
          export CFLAGS="-O2 -pipe -march=armv8.2-a+fp16+dotprod -mtune=cortex-a76"
          export LDFLAGS="-Wl,-O2"
          export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
          
          # Точный путь к native tools
          ../wine-src/configure \
            --host=aarch64-linux-gnu \
            --enable-win64 \
            --with-mingw=clang \
            --with-wine-tools=../native-tools \
            --prefix=/usr \
            --with-x --with-vulkan --with-freetype \
            --with-gstreamer --with-alsa --with-pulse
            
          make -j$(nproc) install DESTDIR=$PWD/root

      # ✅ Winlator/Ludashi WCP формат
      - name: Create Winlator WCP Package
        run: |
          cd arm64-build/root
          
          # Стандартная Winlator структура
          mkdir -p wcp/{bin,lib64/wine,share/wine,share/fonts}
          
          # Бинарники
          mv usr/bin/wine* wcp/bin/ 2>/dev/null || true
          mv usr/bin/wineboot wcp/bin/ 2>/dev/null || true
          mv usr/bin/wineserver wcp/bin/ 2>/dev/null || true
          
          # Основной symlink
          cd wcp/bin && ln -sf wine64 wine && cd ../
          
          # Библиотеки в lib64/wine (Winlator формат)
          find usr -name "*.so*" -path "*/wine/*" -exec mv {} wcp/lib64/wine/ ; 2>/dev/null || true
          find usr/lib/aarch64-linux-gnu/wine -name "*.so*" -exec mv {} wcp/lib64/wine/ ; 2>/dev/null || true
          
          # Шрифты (ОБЯЗАТЕЛЬНО!)
          mkdir -p wcp/share/fonts/{truetype,opentype}
          cp -r /usr/share/fonts/truetype/dejavu wcp/share/fonts/truetype/ 2>/dev/null || true
          
          # Wine share
          cp -r usr/share/wine wcp/share/ 2>/dev/null || true

          # ✅ profile.json (Winlator/Лудashi формат)
          cat > wcp/profile.json <<'EOF'
          {
            "name": "Wine-11.1-Staging-S8G1",
            "version": "11.1",
            "arch": "arm64",
            "type": "wine",
            "variant": "staging",
            "target": "snapdragon-8plus-gen1",
            "glibc": "2.35",
            "abi": "arm64-linux-gnu",
            "features": ["staging","fsr","gstreamer","vulkan","ntsync","esync","fsync"],
            "description": "Wine 11.1 Staging FSR для Ludashi S8+G1",
            "author": "GitHub-CI",
            "env": {
              "WINEESYNC": "1",
              "WINEFSYNC": "1", 
              "WINE_FULLSCREEN_FSR": "1",
              "WINE_CPU_TOPOLOGY": "8:0"
            }
          }
          EOF

          # Финальная архивация WCP
          cd wcp
          find . -type f -exec chmod 755 {} + 2>/dev/null || true
          tar -cJf "$GITHUB_WORKSPACE/wine-11.1-staging-s8g1.wcp" .

          echo "=== Final WCP Structure ==="
          tar -tJf "$GITHUB_WORKSPACE/wine-11.1-staging-s8g1.wcp" | head -20

      - name: Upload WCP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-11.1-staging-s8g1-wcp
          path: wine-11.1-staging-s8g1.wcp
          retention-days: 30
