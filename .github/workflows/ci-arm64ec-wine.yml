name: Build Wine 11 ARM64 (LLVM 21.1.8 Next-Gen)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_wine_native_arm64:
    runs-on: ubuntu-24.04

    env:
      # [...](asc_slot://start-slot-7)Обновляем тулчейн до LLVM 21.1.8 (Release 20251216)
      LLVM_MINGW_URL: https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-20.04-x86_64.tar.xz

    steps:
      - [...](asc_slot://start-slot-9)name: Checkout Repository
        uses: actions/checkout@v4

      # 1. [...](asc_slot://start-slot-11)НАСТРОЙКА РЕПОЗИТОРИЕВ (Nuclear Option)
      - [...](asc_slot://start-slot-13)name: Setup Multiarch & Dependencies
        run: |
          sudo dpkg --add-architecture arm64
          sudo rm -rf /etc/apt/sources.list.d/*
          
          # [...](asc_slot://start-slot-15)Разделение источников: Azure (x86) / Ports (ARM64)
          echo "deb [arch=amd64] http://azure.archive.ubuntu.com/ubuntu noble main restricted universe multiverse" | sudo tee /etc/apt/sources.list
          echo "deb [arch=amd64] http://azure.archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=amd64] http://azure.archive.ubuntu.com/ubuntu noble-backports main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=amd64] http://azure.archive.ubuntu.com/ubuntu noble-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          
          [...](asc_slot://start-slot-17)echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-backports main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          
          [...](asc_slot://start-slot-19)sudo apt-get update
          
          # [...](asc_slot://start-slot-21)Устанавливаем зависимости
          sudo apt-get install -y \
            wget curl git cmake make flex bison pkg-config \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libx11-dev:arm64 libfreetype-dev:arm64 libglib2.0-dev:arm64 \
            libxrender-dev:arm64 libxext-dev:arm64 libxi-dev:arm64 \
            libxrandr-dev:arm64 libxinerama-dev:arm64 libxcursor-dev:arm64 \
            libxcomposite-dev:arm64 libxfixes-dev:arm64 libxxf86vm-dev:arm64 \
            libvulkan-dev:arm64 libxkbcommon-dev:arm64 \
            libsdl2-dev:arm64 libudev-dev:arm64 libgstreamer1.0-dev:arm64 \
            libgnutls28-dev:arm64 libpcap-dev:arm64 libpulse-dev:arm64 \
            libdbus-1-dev:arm64 libfontconfig1-dev:arm64

      # 2. [...](asc_slot://start-slot-23)Установка LLVM-MinGW (LLVM 21.1.8)
      - [...](asc_slot://start-slot-25)name: Setup LLVM MinGW
        run: |
          echo "Downloading LLVM 21.1.8..."
          wget -q "$LLVM_MINGW_URL" -O llvm-mingw.tar.xz
          tar xf llvm-mingw.tar.xz
          EXTRACTED_DIR=$(tar -tf llvm-mingw.tar.xz | head -1 | cut -f1 -d"/")
          mv "$EXTRACTED_DIR" llvm-mingw
          echo "$PWD/llvm-mingw/bin" >> $GITHUB_PATH
          
          # [...](asc_slot://start-slot-27)Проверка версии компилятора
          ./llvm-mingw/bin/clang --version

      - [...](asc_slot://start-slot-29)name: Clone Wine Source
        run: git clone --depth 1 https://gitlab.winehq.org/wine/wine.git wine-src

      # 3. [...](asc_slot://start-slot-31)Сборка инструментов (Host x64)
      - [...](asc_slot://start-slot-33)name: Build Wine Tools (Host x64)
        run: |
          mkdir wine-tools
          cd wine-tools
          ../wine-src/configure --enable-win64 --without-x --without-freetype --without-wayland --without-vulkan
          
          # [...](asc_slot://start-slot-35)Явная сборка нужных инструментов
          make -j$(nproc) \
            tools/winebuild/winebuild \
            tools/widl/widl \
            tools/wrc/wrc \
            tools/wmc/wmc \
            tools/winegcc/winegcc \
            tools/wine/wine

      # 4. [...](asc_slot://start-slot-37)Конфигурация Target (ARM64)
      - [...](asc_slot://start-slot-39)name: Configure Wine (Target ARM64)
        run: |
          mkdir wine-build
          cd wine-build
          
          # ВОЗВРАЩАЕМ МАКСИМАЛЬНУЮ ПРОИЗВОДИТЕЛЬНОСТЬ
          # [...](asc_slot://start-slot-41)LLVM 21+ стабилен на Cortex-X2 с -O3
          export CFLAGS="-O3 -mcpu=cortex-x2 -mtune=cortex-x2 -fno-plt"
          export CROSSCFLAGS="-O3 -mcpu=cortex-x2 -mtune=cortex-x2 -g0 -mstrict-align -Wno-error"
          export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
          
          [...](asc_slot://start-slot-43)../wine-src/configure \
            --host=aarch64-linux-gnu \
            --enable-win64 \
            --without-wine \
            --with-wine-tools=../wine-tools \
            --with-mingw=clang \
            --prefix=/opt/wine-custom \
            --disable-tests \
            --with-x \
            --without-wayland \
            --with-vulkan \
            --with-freetype \
            --without-gstreamer \
            --without-cups \
            --without-sane \
            --without-oss

      # 5. Сборка
      - [...](asc_slot://start-slot-45)name: Build Wine
        working-directory: wine-build
        run: make -j$(nproc)

      # 6. Установка
      - [...](asc_slot://start-slot-47)name: Install to Image
        working-directory: wine-build
        run: make install DESTDIR=$PWD/../image

      # 7. Упаковка .wcp
      - [...](asc_slot://start-slot-49)name: Package .wcp
        run: |
          cd image/opt
          mv wine-custom Wine-11.0-ARM64
          
          [...](asc_slot://start-slot-51)cat <<EOF > Wine-11.0-ARM64/info.json
          {
            "name": "Wine-11.0-ARM64-LLVM21",
            "version": "11.0-git",
            "arch": "arm64",
            "author": "GitHubCI",
            "description": "Native AArch64 (X11). [...](asc_slot://start-slot-53)LLVM 21.1.8. [...](asc_slot://start-slot-54)Cortex-X2 Max Perf."
          }
          EOF
          
          [...](asc_slot://start-slot-56)cat <<EOF > Wine-11.0-ARM64/env.sh
          #!/bin/sh
          export WINEDEBUG="-all"
          EOF
          chmod +x Wine-11.0-ARM64/env.sh
          
          [...](asc_slot://start-slot-58)tar -cJf ../../wine-11-arm64-llvm21.wcp Wine-11.0-ARM64

      - [...](asc_slot://start-slot-60)name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-11-arm64-llvm21.wcp
          path: wine-11-arm64-llvm21.wcp
