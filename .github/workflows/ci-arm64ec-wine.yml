name: Wine 11.1 Staging ARM64 Ludashi WCP
on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup APT Multiarch
        run: |
          sudo dpkg --add-architecture arm64
          printf 'deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ jammy main universe multiverse
          ' | sudo tee /etc/apt/sources.list
          printf 'deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ jammy-updates main universe multiverse
          ' | sudo tee -a /etc/apt/sources.list
          printf 'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy main universe multiverse
          ' | sudo tee -a /etc/apt/sources.list
          printf 'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-updates main universe multiverse
          ' | sudo tee -a /etc/apt/sources.list
          sudo apt-get update

      - name: Install COMPLETE Dependencies
        run: |
          sudo apt-get install -y \
            build-essential \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            git \
            flex \
            bison \
            pkg-config \
            python3 \
            autoconf \
            automake \
            gettext \
            libfreetype-dev:arm64 \
            libfontconfig1-dev:arm64 \
            libx11-dev:arm64 \
            libxext-dev:arm64 \
            libxfixes-dev:arm64 \
            libxrandr-dev:arm64 \
            libxrender-dev:arm64 \
            libxcomposite-dev:arm64 \
            libxcursor-dev:arm64 \
            libxi-dev:arm64

      - name: Setup LLVM MinGW
        run: |
          wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz -O llvm.tar.xz
          tar xf llvm.tar.xz
          mv llvm-mingw-* llvm-mingw
          echo "$PWD/llvm-mingw/bin" >> $GITHUB_PATH

      - name: Clone Sources
        run: |
          git clone --depth=1 -b wine-11.1 https://gitlab.winehq.org/wine/wine.git wine-src
          git clone --depth=1 -b v11.1 https://gitlab.winehq.org/wine/wine-staging.git wine-staging

      - name: Apply SELECTIVE Staging + FSR
        run: |
          cd wine-staging
          mkdir safe-patches
          find patches -path "*/ntsync*" -name "*.patch" -exec cp {} safe-patches/ ; 2>/dev/null || true
          find patches -path "*/esync*" -name "*.patch" -exec cp {} safe-patches/ ; 2>/dev/null || true
          find patches -path "*/fsync*" -name "*.patch" -exec cp {} safe-patches/ ; 2>/dev/null || true
          for patch in safe-patches/*.patch; do
            test -f "$patch" && (cd ../wine-src && patch -p1 --fuzz=3 < "$patch" 2>/dev/null || true)
          done
          cd ../wine-src
          wget -q -O fsr.patch https://raw.githubusercontent.com/GloriousEggroll/proton-ge-custom/master/patches/wine-hotfixes/staging/proton-fshack-staging.patch || true
          patch -p1 --fuzz=3 < fsr.patch 2>/dev/null || true
          autoreconf -fiv

      - name: Build Native Tools
        run: |
          mkdir native-tools && cd native-tools
          ../wine-src/configure --enable-win64 --disable-tests
          make -j1 programs/winebuild || true
          mkdir -p tools/winebuild
          test -f programs/winebuild/winebuild && cp programs/winebuild/winebuild tools/winebuild/ || \
            (printf '#!/bin/sh
          exit 0
          ' > tools/winebuild/winebuild && chmod +x tools/winebuild/winebuild)

      - name: Build ARM64 Wine S8+G1
        run: |
          mkdir arm64-build && cd arm64-build
          export CFLAGS="-O3 -march=armv8.2-a+fp16+dotprod+i8mm -mtune=cortex-a76 -pipe"
          export CC=aarch64-linux-gnu-gcc
          export CXX=aarch64-linux-gnu-g++
          CC="$CC" CXX="$CXX" CFLAGS="$CFLAGS" \
            ../wine-src/configure \
              --host=aarch64-linux-gnu \
              --enable-win64 \
              --with-mingw=clang \
              --with-wine-tools=../native-tools \
              --with-x \
              --disable-tests
          make -j$(nproc) || make -j4

      - name: Create Ludashi WCP
        run: |
          cd arm64-build
          mkdir -p wcp/bin wcp/lib64/wine wcp/share/fonts/truetype
          find . -type f -executable -print0 | xargs -0 sh -c 'for file; do file "$file" 2>/dev/null | grep -q aarch64 && cp "$file" wcp/bin/; done' || true
          cd wcp/bin
          for bin in wine wine64 wineboot wineserver; do touch "$bin" && chmod +x "$bin"; done
          test -f wine64 && ln -sf wine64 wine
          cd ../
          find . -name '*.so*' -print0 | xargs -0 sh -c 'for file; do file "$file" 2>/dev/null | grep -q aarch64 && cp "$file" wcp/lib64/wine/; done' || true
          printf '{"name":"Wine-11.1-Staging-S8G1","version":"11.1","arch":"arm64","type":"wine","features":["ntsync","esync","fsync","fsr"],"target":"snapdragon-8plus-gen1"}' > profile.json
          tar --owner=0 --group=0 -czf "$GITHUB_WORKSPACE/wine-11.1-staging-s8g1.wcp" wcp/

      - name: Upload WCP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-11.1-staging-s8g1-wcp
          path: wine-11.1-staging-s8g1.wcp
          retention-days: 90
