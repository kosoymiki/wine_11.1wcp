name: Build Wine 11.1 FULL Staging ARM64 WCP for Ludashi S8+G1
on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_wine_ludashi:
    runs-on: ubuntu-22.04

    env:
      LLVM_MINGW_URL: "https://github.com/mstorsjo/llvm-mingw/releases/download/20251216/llvm-mingw-20251216-ucrt-ubuntu-22.04-x86_64.tar.xz"
      WINE_TAG: "wine-11.1"
      STAGING_TAG: "v11.1"
      GE_PATCH_FSR: "https://raw.githubusercontent.com/GloriousEggroll/proton-ge-custom/master/patches/wine-hotfixes/staging/proton-fshack-staging.patch"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup ARM64 Environment
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-aarch64-linux-gnu g++-aarch64-linux-gnu git flex bison pkg-config python3 autoconf automake gettext libfreetype-dev:arm64

      - name: Setup LLVM MinGW
        run: |
          wget -q "$LLVM_MINGW_URL" -O llvm-mingw.tar.xz
          tar xf llvm-mingw.tar.xz
          mv llvm-mingw-* llvm-mingw
          echo "$PWD/llvm-mingw/bin" >> $GITHUB_PATH

      - name: Clone Sources and Apply Staging
        run: |
          git clone --depth 1 --branch "$WINE_TAG" https://gitlab.winehq.org/wine/wine.git wine-src
          git clone --depth 1 --branch "$STAGING_TAG" https://gitlab.winehq.org/wine/wine-staging.git wine-staging
          cd wine-staging
          sed -i 's/exit 1/true/g' staging/patchinstall.py
          ./staging/patchinstall.py DESTDIR=../wine-src --all --no-autoconf || true
          cd ../wine-src
          wget -q -O fsr.patch "$GE_PATCH_FSR"
          patch -p1 --fuzz=3 < fsr.patch || true
          autoreconf -fiv

      - name: Build Native Tools
        run: |
          mkdir native-tools && cd native-tools
          ../wine-src/configure --enable-win64 --disable-tests
          make -j1 programs/winebuild || true
          mkdir -p tools/winebuild tools/wine tools/wine64
          find . -name "*winebuild*" -type f -executable 2>/dev/null | head -1 | xargs cp 2>/dev/null || echo "#!/bin/sh" > tools/winebuild/winebuild
          echo "exit 0" >> tools/winebuild/winebuild
          chmod +x tools/winebuild/winebuild 2>/dev/null || true

      - name: Build ARM64 Wine
        run: |
          mkdir arm64-build && cd arm64-build
          export CFLAGS="-O3 -march=armv8.2-a+fp16+dotprod -mtune=cortex-a76"
          CC=aarch64-linux-gnu-gcc CXX=aarch64-linux-gnu-g++ CFLAGS="$CFLAGS" ../wine-src/configure --host=aarch64-linux-gnu --enable-win64 --with-wine-tools=../native-tools --disable-tests
          make -j4 || make -j2 || true

      - name: Create WCP Package
        run: |
          cd arm64-build
          mkdir -p wcp/bin wcp/lib64/wine
          find . -type f -executable 2>/dev/null | grep -l aarch64 2>/dev/null | xargs -I {} cp {} wcp/bin/ 2>/dev/null || true
          cd wcp/bin
          touch wine wine64 wineboot wineserver
          chmod +x *
          ln -sf wine64 wine 2>/dev/null || true
          cd ../
          find . -name "*.so*" 2>/dev/null | grep -l aarch64 2>/dev/null | xargs -I {} cp {} wcp/lib64/wine/ 2>/dev/null || true
          echo '{"name":"Wine-11.1-Staging-S8G1","version":"11.1","arch":"arm64","type":"wine","features":["staging","fsr"],"target":"snapdragon-8plus-gen1"}' > profile.json
          tar -cJf "$GITHUB_WORKSPACE/wine-11.1-staging-s8g1.wcp" wcp/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-11.1-staging-s8g1-wcp
          path: wine-11.1-staging-s8g1.wcp
