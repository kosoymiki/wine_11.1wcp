name: Build Wine 11.1 Staging ARM64EC PHAT wcp

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install base deps
        run: |
          set -euxo pipefail
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential git wget curl ca-certificates file \
            python3 perl gettext \
            pkgconf cmake ninja-build meson \
            autoconf automake libtool \
            patchutils bison flex \
            libc6-dev linux-libc-dev \
            libfreetype-dev libfreetype6-dev \
            libfontconfig-dev \
            libdbus-1-dev \
            libx11-dev libxext-dev libxrender-dev \
            libxrandr-dev libxinerama-dev \
            libxcursor-dev libxi-dev libxfixes-dev \
            libpulse-dev libasound2-dev \
            libudev-dev libgl-dev \
            rsync zip xz-utils
          # pkg-config name
          sudo ln -sf /usr/bin/pkgconf /usr/local/bin/pkg-config || true

          # sanity: these must exist on the build host
          pkg-config --modversion freetype2
          pkg-config --modversion fontconfig
          pkg-config --modversion dbus-1

      - name: Setup llvm-mingw (prebuilt, with arch check + fallback)
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          LLVM_MINGW_VERSION="20251216"
          CRT="ucrt"
          DISTRO="ubuntu-22.04"

          rm -rf "$ROOT/llvm-mingw"
          mkdir -p "$ROOT/llvm-mingw"

          HOST_UNAME="$(uname -m)"
          case "$HOST_UNAME" in
            aarch64|arm64) HOST_ASSET_ARCH="aarch64" ;;
            x86_64|amd64)  HOST_ASSET_ARCH="x86_64"  ;;
            *) echo "Unsupported runner arch: $HOST_UNAME" >&2; exit 1 ;;
          esac

          ASSET="llvm-mingw-${LLVM_MINGW_VERSION}-${CRT}-${DISTRO}-${HOST_ASSET_ARCH}.tar.xz"
          URL="https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/${ASSET}"

          echo "Runner arch: $HOST_UNAME; trying asset: $ASSET"
          wget -q "$URL" -O "$ROOT/llvm-mingw.tar.xz"
          tar -xJf "$ROOT/llvm-mingw.tar.xz" -C "$ROOT/llvm-mingw" --strip-components=1
          rm -f "$ROOT/llvm-mingw.tar.xz"

          # Verify host executable arch (this is what was breaking you)
          file "$ROOT/llvm-mingw/bin/clang" || true
          if ! file "$ROOT/llvm-mingw/bin/clang" | grep -qiE '(aarch64|ARM aarch64)'; then
            echo "Prebuilt clang is NOT aarch64 on an ARM runner -> Exec format error would happen. Fallback: build from source."
            rm -rf "$ROOT/llvm-mingw"
            mkdir -p "$ROOT/llvm-mingw"

            rm -rf "$ROOT/llvm-mingw-src"
            git clone --depth 1 https://github.com/mstorsjo/llvm-mingw.git "$ROOT/llvm-mingw-src"
            # Per upstream README: ./build-all.sh <target-dir>
            # This is slower, but it produces correct host binaries on ARM. 12
            "$ROOT/llvm-mingw-src/build-all.sh" "$ROOT/llvm-mingw"
          fi

          echo "$ROOT/llvm-mingw/bin" >> "$GITHUB_PATH"
          ls -1 "$ROOT/llvm-mingw/bin" | head -n 50

          # Provide triplet-prefixed pkg-config expected by Wine configure
          for t in aarch64-w64-mingw32 arm64ec-w64-mingw32 x86_64-w64-mingw32 i686-w64-mingw32; do
            ln -sf /usr/local/bin/pkg-config "$ROOT/llvm-mingw/bin/${t}-pkg-config" || true
          done

      - name: Verify llvm-mingw toolchain actually runs (no Exec format error)
        run: |
          set -euxo pipefail
          aarch64-w64-mingw32-clang --version
          if command -v arm64ec-w64-mingw32-clang; then arm64ec-w64-mingw32-clang --version; fi
          command -v llvm-dlltool || true
          command -v lld || true
          if command -v lld-link; then lld-link --version || true; fi

      - name: Verify cross compiler simple test
        run: |
          set -euxo pipefail
          echo 'int main(void){return 0;}' > /tmp/test.c
          aarch64-w64-mingw32-clang -o /tmp/test.exe /tmp/test.c -Wl,--no-undefined
          file /tmp/test.exe

      - name: Clone Wine & Wine-Staging
        run: |
          set -euxo pipefail
          rm -rf wine wine-staging
          git clone --depth 1 --branch wine-11.1 https://gitlab.winehq.org/wine/wine.git wine
          git clone --depth 1 --branch v11.1 https://gitlab.winehq.org/wine/wine-staging.git wine-staging

      - name: Apply staging patches
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          python3 wine-staging/staging/patchinstall.py -d "$ROOT/wine" -a --no-autoconf
          cd "$ROOT/wine"
          autoreconf -fiv
          ./tools/make_requests

      - name: Build wine tools (native) and export in both tools/ and bin/
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"

          rm -rf "$ROOT/wine-tools"
          mkdir -p "$ROOT/wine-tools"

          cd "$ROOT/wine"
          rm -rf tools-build
          mkdir -p tools-build
          cd tools-build

          ../configure \
            --disable-tests \
            --disable-win16 \
            --with-freetype \
            --with-fontconfig \
            --without-vulkan \
            --without-dbus \
            --without-alsa \
            --without-pulse \
            --without-wayland

          make -j"$(nproc)" \
            tools/winebuild/winebuild \
            tools/widl/widl \
            tools/wrc/wrc \
            tools/makedep \
            tools/winegcc/winegcc \
            tools/wmc/wmc

          # Export in a layout that Wine configure reliably finds
          mkdir -p "$ROOT/wine-tools/tools"/{winebuild,widl,wrc,winegcc,wmc}
          cp tools/winebuild/winebuild "$ROOT/wine-tools/tools/winebuild/"
          cp tools/widl/widl           "$ROOT/wine-tools/tools/widl/"
          cp tools/wrc/wrc             "$ROOT/wine-tools/tools/wrc/"
          cp tools/winegcc/winegcc     "$ROOT/wine-tools/tools/winegcc/"
          cp tools/wmc/wmc             "$ROOT/wine-tools/tools/wmc/"

          # makedep can be either tools/makedep or tools/makedep/makedep depending on tree
          if [ -x tools/makedep/makedep ]; then
            mkdir -p "$ROOT/wine-tools/tools/makedep"
            cp tools/makedep/makedep "$ROOT/wine-tools/tools/makedep/makedep"
            ln -sf makedep/makedep "$ROOT/wine-tools/tools/makedep"
          else
            cp tools/makedep "$ROOT/wine-tools/tools/makedep"
          fi

          # Also provide bin/ with flat names (some configure paths expect this)
          mkdir -p "$ROOT/wine-tools/bin"
          ln -sf ../tools/winebuild/winebuild "$ROOT/wine-tools/bin/winebuild"
          ln -sf ../tools/widl/widl           "$ROOT/wine-tools/bin/widl"
          ln -sf ../tools/wrc/wrc             "$ROOT/wine-tools/bin/wrc"
          ln -sf ../tools/winegcc/winegcc     "$ROOT/wine-tools/bin/winegcc"
          ln -sf ../tools/wmc/wmc             "$ROOT/wine-tools/bin/wmc"
          ln -sf ../tools/makedep             "$ROOT/wine-tools/bin/makedep" || true

          ls -lR "$ROOT/wine-tools" | head -n 200
          test -e "$ROOT/wine-tools/tools/makedep" || test -e "$ROOT/wine-tools/tools/makedep/makedep"

      - name: Configure Wine (cross ARM64EC)
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          export PATH="$ROOT/llvm-mingw/bin:$PATH"

          rm -rf "$ROOT/wine-build"
          mkdir -p "$ROOT/wine-build"
          cd "$ROOT/wine-build"

          export CC=aarch64-w64-mingw32-clang
          export CXX=aarch64-w64-mingw32-clang++
          export AR=aarch64-w64-mingw32-ar
          export RANLIB=aarch64-w64-mingw32-ranlib
          export STRIP=aarch64-w64-mingw32-strip

          # Ensure configure can discover host libs via our triplet-pkg-config wrappers
          export PKG_CONFIG=/usr/local/bin/pkg-config
          export PKG_CONFIG_LIBDIR="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig"

          "$ROOT/wine/configure" \
            --host=aarch64-w64-mingw32 \
            --prefix=/usr \
            --with-wine-tools="$ROOT/wine-tools" \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64 \
            --disable-tests \
            --with-freetype \
            --with-fontconfig \
            --with-dbus \
            --with-alsa

      - name: Build Wine
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          cd "$ROOT/wine-build"
          make -j"$(nproc)"

      - name: Install Wine
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          cd "$ROOT/wine-build"
          rm -rf "$ROOT/wine-install"
          DESTDIR="$ROOT/wine-install" make install

      - name: Build Turnip / Mesa (optional)
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          rm -rf "$ROOT/external"
          mkdir -p "$ROOT/external"
          git clone --depth 1 https://github.com/whitebelyash/mesa-tu8 "$ROOT/external/mesa-src"
          meson setup "$ROOT/external/mesa-build" "$ROOT/external/mesa-src" \
            -Dvulkan-drivers=turnip -Dplatforms=none -Dbuildtype=release
          ninja -C "$ROOT/external/mesa-build"
          DESTDIR="$ROOT/external/mesa-install" ninja -C "$ROOT/external/mesa-build" install

      - name: Unpack DXVK VKD3D FEXCore
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          mkdir -p "$ROOT/external/dxvk" "$ROOT/external/vkd3d" "$ROOT/external/fexcore"
          wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/DXVK-GPLASYNC-ARM64EC/dxvk-gplasync-arm64ec-2.7.1-1.wcp" -O dxvk.wcp
          tar -xJf dxvk.wcp -C "$ROOT/external/dxvk"
          wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/VKD3D-PROTON-ARM64EC/vkd3d-proton-arm64ec-3.0b.wcp" -O vkd3d.wcp
          tar -xJf vkd3d.wcp -C "$ROOT/external/vkd3d"
          wget -q "https://github.com/Arihany/WinlatorWCPHub/releases/download/FEXCore/FEXCore-2601.wcp" -O fexcore.wcp
          tar -xJf fexcore.wcp -C "$ROOT/external/fexcore"

      - name: Assemble PHAT wcp
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"
          mkdir -p "$ROOT/wcp"/{bin,lib/wine,dxvk/arm64ec,vkd3d/arm64ec,mesa/turnip}
          cp -v "$ROOT/wine-install/usr/bin/"{wine,wine64,wineboot,wineserver} "$ROOT/wcp/bin/" || true
          rsync -a "$ROOT/wine-install/usr/lib/wine/" "$ROOT/wcp/lib/wine/" || true
          rsync -a "$ROOT/external/dxvk/" "$ROOT/wcp/dxvk/arm64ec/" || true
          rsync -a "$ROOT/external/vkd3d/" "$ROOT/wcp/vkd3d/arm64ec/" || true
          rsync -a "$ROOT/external/fexcore/" "$ROOT/wcp/lib/wine/" || true
          cp -v "$ROOT/external/mesa-install/usr/local/lib/"* "$ROOT/wcp/mesa/turnip/" || true
          cat > "$ROOT/wcp/env.sh" << 'EOF'
          #!/bin/sh
          export WINEDEBUG=-all
          export DXVK_ASYNC=1
          export MESA_LOADER_DRIVER_OVERRIDE=turnip
          export WINEPREFIX=~/.wine
          export WINEARCH=win64
          EOF
          chmod +x "$ROOT/wcp/env.sh"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wine-arm64ec-phat
          path: wcp
