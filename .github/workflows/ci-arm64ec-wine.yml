name: Build Wine 11.1 Staging ARM64EC (PHAT .wcp)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64ec:
    runs-on: ubuntu-24.04-arm
    defaults:
      run:
        shell: bash

    env:
      WINE_TAG: "wine-11.1"
      STAGING_TAG: "v11.1"
      LLVM_MINGW_VERSION: "20251216"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Init flat paths (NO github.workspace)
        run: |
          set -euxo pipefail
          ROOT="$(pwd)"

          echo "ROOT=$ROOT" >> "$GITHUB_ENV"
          echo "WINEDIR=$ROOT/wine" >> "$GITHUB_ENV"
          echo "STAGINGDIR=$ROOT/wine-staging" >> "$GITHUB_ENV"
          echo "LLVM_MINGW_DIR=$ROOT/llvm-mingw" >> "$GITHUB_ENV"

          echo "WINE_TOOLS_DIR=$ROOT/wine-tools" >> "$GITHUB_ENV"
          echo "TOOLS_BUILDDIR=$ROOT/tools-build" >> "$GITHUB_ENV"

          echo "BUILDDIR=$ROOT/wine-build" >> "$GITHUB_ENV"
          echo "INSTALLDIR=$ROOT/wine-install" >> "$GITHUB_ENV"

          echo "EXTERNALDIR=$ROOT/external" >> "$GITHUB_ENV"
          echo "WCP_DIR=$ROOT/wcp" >> "$GITHUB_ENV"

          pwd
          ls -la

      - name: Install build dependencies
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential wget git python3 gettext \
            pkgconf cmake ninja-build meson \
            autoconf automake libtool \
            patchutils bison flex \
            libc6-dev libfreetype-dev libfontconfig-dev \
            libsdl2-dev libpulse-dev libasound2-dev \
            libdbus-1-dev libdb-dev \
            libavcodec-dev libavformat-dev libavutil-dev libswscale-dev \
            libudev-dev ca-certificates \
            zip rsync file xz-utils
          sudo ln -sf /usr/bin/pkgconf /usr/local/bin/pkg-config || true

      - name: Setup LLVM-Mingw (./llvm-mingw)
        run: |
          set -euxo pipefail
          rm -rf "$LLVM_MINGW_DIR"
          mkdir -p "$LLVM_MINGW_DIR"

          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz"
          tar -xJf "llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz" -C "$LLVM_MINGW_DIR" --strip-components=1
          rm -f "llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-22.04-aarch64.tar.xz"

          echo "$LLVM_MINGW_DIR/bin" >> "$GITHUB_PATH"
          ls -la "$LLVM_MINGW_DIR/bin" | head -n 50

      - name: Verify cross-compiler is реально в PATH
        run: |
          set -euxo pipefail
          command -v aarch64-w64-mingw32-clang
          aarch64-w64-mingw32-clang --version
          echo 'int main(void){}' > /tmp/test.c
          aarch64-w64-mingw32-clang -o /tmp/test.exe /tmp/test.c -Wl,--no-undefined
          file /tmp/test.exe

      - name: Clone Wine & Wine-Staging by tags (flat: ./wine, ./wine-staging)
        run: |
          set -euxo pipefail
          rm -rf "$WINEDIR" "$STAGINGDIR"

          git clone https://gitlab.winehq.org/wine/wine.git "$WINEDIR"
          git -C "$WINEDIR" fetch --tags --force
          git -C "$WINEDIR" checkout -qf "$WINE_TAG"

          git clone https://gitlab.winehq.org/wine/wine-staging.git "$STAGINGDIR"
          git -C "$STAGINGDIR" fetch --tags --force
          git -C "$STAGINGDIR" checkout -qf "$STAGING_TAG"

      - name: Apply staging patches + regenerate build system
        run: |
          set -euxo pipefail
          python3 "$STAGINGDIR/staging/patchinstall.py" -d "$WINEDIR" -a --no-autoconf

          cd "$WINEDIR"
          autoreconf -fiv
          ./tools/make_requests

      - name: Build host Wine tools (ARM64 Linux) -> ./wine-tools/bin
        run: |
          set -euxo pipefail

          rm -rf "$TOOLS_BUILDDIR" "$WINE_TOOLS_DIR"
          mkdir -p "$TOOLS_BUILDDIR" "$WINE_TOOLS_DIR/bin"

          cd "$TOOLS_BUILDDIR"

          # Нативная конфигурация (aarch64-linux). Никаких prefix/bin.
          "$WINEDIR/configure" \
            --disable-tests \
            --without-vulkan

          # Собираем ровно то, что cross-configure будет искать.
          # В Wine дерево обычно такое: tools/winebuild/winebuild, tools/widl/widl, tools/wrc/wrc, tools/makedep
          make -j"$(nproc)" \
            tools/winebuild/winebuild \
            tools/widl/widl \
            tools/wrc/wrc \
            tools/makedep

          install -D -m 755 tools/winebuild/winebuild "$WINE_TOOLS_DIR/bin/winebuild"
          install -D -m 755 tools/widl/widl           "$WINE_TOOLS_DIR/bin/widl"
          install -D -m 755 tools/wrc/wrc             "$WINE_TOOLS_DIR/bin/wrc"
          install -D -m 755 tools/makedep             "$WINE_TOOLS_DIR/bin/makedep"

          ls -la "$WINE_TOOLS_DIR/bin"
          test -x "$WINE_TOOLS_DIR/bin/winebuild"
          test -x "$WINE_TOOLS_DIR/bin/widl"
          test -x "$WINE_TOOLS_DIR/bin/wrc"
          test -x "$WINE_TOOLS_DIR/bin/makedep"

      - name: Configure Wine (cross-compile) (flat: ./wine-build)
        run: |
          set -euxo pipefail

          rm -rf "$BUILDDIR"
          mkdir -p "$BUILDDIR"
          cd "$BUILDDIR"

          export CC=aarch64-w64-mingw32-clang
          export CXX=aarch64-w64-mingw32-clang++
          export AR=aarch64-w64-mingw32-ar
          export RANLIB=aarch64-w64-mingw32-ranlib
          export STRIP=aarch64-w64-mingw32-strip

          "$WINEDIR/configure" \
            --host=aarch64-w64-mingw32 \
            --with-wine-tools="$WINE_TOOLS_DIR/bin" \
            --enable-win64 \
            --enable-wow64 \
            --enable-archs=arm64ec,aarch64 \
            --disable-tests \
            --without-vulkan

      - name: Build + install to flat: ./wine-install
        run: |
          set -euxo pipefail
          rm -rf "$INSTALLDIR"
          mkdir -p "$INSTALLDIR"

          cd "$BUILDDIR"
          make -j"$(nproc)"
          DESTDIR="$INSTALLDIR" make install

      # Дальнейшие шаги (mesa/dxvk/vkd3d/fex/wcp) можешь вернуть после того,
      # как пройдёт configure и сборка Wine. Сейчас у тебя узкое место — tools/paths.
      - name: Upload wine-install (debug artifact)
        uses: actions/upload-artifact@v4
        with:
          name: wine-install-arm64ec-debug
          path: ${{ env.INSTALLDIR }}
